using reposicion_pin.DTOs;
using reposicion_pin.Repository.Interface;
using System.Data;
using System.Data.OleDb;

namespace reposicion_pin.Repository
{
    public class AS400Repository : IAS400Repository
    {
        private readonly string _connectionString;
        private readonly ILogger<AS400Repository> _logger;

        public AS400Repository(
            IConfiguration configuration,
            ILogger<AS400Repository> logger)
        {
            _connectionString = configuration.GetConnectionString("AS400Connection")!;
            _logger = logger;
        }

        public async Task<AS400ResponseDto> EjecutarProgramaAsync(AS400RequestDto request)
        {
            try
            {
                using var conn = new OleDbConnection(_connectionString);
                await conn.OpenAsync();

                // 1️⃣ Asegurar que las librerías necesarias estén en el library list
                string librerias = "DP053DAT CLIDAT BPDAT BPPGM TDBI20DAT TARJETA";
                using (var libCmd = new OleDbCommand($"CHGLIBL LIBL({librerias})", conn))
                {
                    libCmd.CommandType = CommandType.Text;
                    libCmd.ExecuteNonQuery();
                }

                // 2️⃣ Construir la trama de 81 caracteres exactamente
                string trama =
                    (request.EquivalenteTC?.PadRight(16).Substring(0, 16) ?? new string(' ', 16)) +
                    (request.FechaVencimiento?.PadRight(8).Substring(0, 8) ?? new string(' ', 8)) +
                    new string(' ', 57); // Total = 16 + 8 + 57 = 81

                _logger.LogDebug("Trama enviada: {Trama}", trama);

                // 3️⃣ Preparar el comando para el stored procedure
                using var cmd = new OleDbCommand("SP_REIMQ07RC", conn)
                {
                    CommandType = CommandType.StoredProcedure,
                    CommandTimeout = 300
                };

                var paramTrama = new OleDbParameter
                {
                    OleDbType = OleDbType.Char,
                    Size = 81,
                    Direction = ParameterDirection.InputOutput,
                    Value = trama
                };

                cmd.Parameters.Add(paramTrama);

                _logger.LogInformation("Ejecutando SP_REIMQ07RC en AS400");

                // 4️⃣ Ejecutar de forma segura con async
                await Task.Run(() => cmd.ExecuteNonQuery());

                string tramaRespuesta = paramTrama.Value?.ToString() ?? string.Empty;

                // 5️⃣ Parsear la respuesta
                return ParsearRespuesta(tramaRespuesta);
            }
            catch (OleDbException ex)
            {
                _logger.LogError(ex, "Error OleDb AS400");
                return new AS400ResponseDto
                {
                    CodigoError = "P98",
                    DescripcionError = "ERROR AL LLAMAR A MQ"
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error inesperado AS400");
                return new AS400ResponseDto
                {
                    CodigoError = "P99",
                    DescripcionError = "TRAMA NO ENCONTRADA"
                };
            }
        }

        private static AS400ResponseDto ParsearRespuesta(string trama)
        {
            if (string.IsNullOrEmpty(trama) || trama.Length < 81)
            {
                return new AS400ResponseDto
                {
                    CodigoError = "P99",
                    DescripcionError = "TRAMA RESPUESTA INVÁLIDA"
                };
            }

            return new AS400ResponseDto
            {
                Pin = trama.Substring(24, 4).Trim(),
                CodigoError = trama.Substring(28, 3).Trim(),
                DescripcionError = trama.Substring(31, 50).Trim()
            };
        }
    }
}
