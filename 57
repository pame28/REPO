using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using reposicion_pin.Infrastructure.Data;
using reposicion_pin.Models;
using reposicion_pin.Repository.Interface;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
using System.Xml;
using wsBIMovil;

namespace reposicion_pin.Repository
{
    public class EnvioSmsRepository : IEnvioSmsRepository
    {
        private readonly AppDbContext _dbContext;
        private readonly ILogger<EnvioSmsRepository> _logger;
        private readonly MensajesSoapClient _mensajesSoapClient;
        private readonly string _UsrBiMovil;
        private readonly string _PassBiMovil;
        private readonly ParamAmbienteModel _paramAmbiente;

        public EnvioSmsRepository(AppDbContext dbContext, IConfiguration configuration, ILogger<EnvioSmsRepository> logger)
        {
            _dbContext = dbContext;
            _logger = logger;

            // Obtener configuración de BiMovil desde SP
            var configBiMovil = _dbContext
                .usp_ObtenerConfigBiMovil
                .AsEnumerable()
                .FirstOrDefault();
            if (configBiMovil == null)
                throw new Exception("No se encontró configuración de BiMovil.");

            _UsrBiMovil = configBiMovil.UserBiMovil;
            _PassBiMovil = configBiMovil.PassBiMovil;

            _paramAmbiente = _dbContext.ParamAmbiente
                .Where(p => p.Estado ==1)
                .OrderBy(p => p.IdRow)
                .FirstOrDefault();

            _mensajesSoapClient = new MensajesSoapClient(MensajesSoapClient.EndpointConfiguration.MensajesSoap);
        }

        public async Task<(int Codigo, string Mensaje)>
       EnviarSmsDirectoAsync(
           string telefono,
           string operador,
           string mensajeBase,
           string pin,
           string referencia,
           CancellationToken cancellationToken)
        {
            try
            {
                string telefonoFinal = _paramAmbiente?.Telefono ?? telefono;
                string operadorFinal = _paramAmbiente?.IdOperador ?? operador;

                string mensajeFinal = mensajeBase + pin;

                int enmascararDesde = mensajeBase.Length + 1;
                int enmascararHasta = mensajeFinal.Length;


                var response = await _mensajesSoapClient.Envia_MensajeAsync(
                    _UsrBiMovil,
                    _PassBiMovil,
                    telefonoFinal,
                    operadorFinal,
                    mensajeFinal,
                    referencia,
                    enmascararDesde.ToString(),
                    enmascararHasta.ToString()
                  
                );

                XmlDocument xmlDoc = new XmlDocument();
                xmlDoc.LoadXml(response.Envia_MensajeResult.Any1.InnerXml);

                XmlNode nodoCod = xmlDoc.GetElementsByTagName("cod_ret")[0];
                XmlNode nodoMensaje = xmlDoc.GetElementsByTagName("mensaje")[0];

               
                int codigo = nodoCod != null ? int.Parse(nodoCod.InnerText) : 99;
                string mensajeRespuesta = nodoMensaje?.InnerText ?? "Respuesta inválida";

                _logger.LogInformation(
                    "BiMovil Ref:{Referencia} Codigo:{Codigo} Mensaje:{Mensaje}",
                    referencia, codigo, mensajeRespuesta);

                return (codigo, mensajeRespuesta);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error enviando SMS Ref:{Referencia}", referencia);
                return (99, ex.Message);
            }
        }
      

        
    }
}








Mira que este me devuelve un codigo y mensajeRespuesta



Y es lo que espero que se inserte en el de SMS

using reposicion_pin.DTOs;
using reposicion_pin.Models;
using reposicion_pin.Repository.Interface;
using reposicion_pin.Service.Interface;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;

namespace reposicion_pin.Service
{
    public class NotificacionService : INotificacionService
    {
        private readonly IEnvioSmsRepository _envioSmsRepository;
        private readonly IBandejaEnvioSmsRepository _bandejaSmsRepository;
        private readonly IEnvioEmailRepository _envioEmailRepository;
        private readonly IBandejaEnvioEmailRepository _bandejaEmailRepository;
        private readonly IConfiguration _configuration;
        private readonly ILogger<NotificacionService> _logger;
        private readonly ICatalogoRespuestaRepository _catalogoRepository; // <- agregado

        public NotificacionService(
            IEnvioSmsRepository envioSmsRepository,
            IBandejaEnvioSmsRepository bandejaSmsRepository,
            IEnvioEmailRepository envioEmailRepository,
            IBandejaEnvioEmailRepository bandejaEmailRepository,
            IConfiguration configuration,
            ICatalogoRespuestaRepository catalogoRepository, // <- agregado
            ILogger<NotificacionService> logger)
        {
            _envioSmsRepository = envioSmsRepository;
            _bandejaSmsRepository = bandejaSmsRepository;
            _envioEmailRepository = envioEmailRepository;
            _bandejaEmailRepository = bandejaEmailRepository;
            _configuration = configuration;
            _catalogoRepository = catalogoRepository;
            _logger = logger;
        }

        public async Task<ReposicionPinResponseDto> EnviarNotificacionAsync(TarjetaModel tarjeta, ReposicionPinRequestDto request, string pin)
        {
            try
            {
                if (request.MetodoEnvio == 1)
                    return await EnviarSmsAsync(tarjeta, request, pin);
                else
                    return await EnviarEmailAsync(tarjeta, request, pin);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error inesperado en EnviarNotificacionAsync");
                return new ReposicionPinResponseDto { CodigoInt = 99, Descripcion = ex.Message };
            }
        }

        #region Métodos privados
        private async Task<ReposicionPinResponseDto> EnviarSmsAsync(TarjetaModel tarjeta, ReposicionPinRequestDto request, string pin)
        {
            long numeroTransaccion = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
            string referencia = numeroTransaccion.ToString();

            var resultado = await _envioSmsRepository.EnviarSmsDirectoAsync(
                request.Telefono,
                request.OperadorTelefono,
                request.ContenidoSMS.Replace("@PIN", ""),
                pin,
                referencia,
                CancellationToken.None
            );

            await InsertarRegistroEnvioSmsAsync(tarjeta, request, referencia, resultado.Codigo, resultado.Mensaje);

            if (resultado.Codigo != 0)
            {
                var respuesta = await ObtenerRespuestaCatalogoAsync(7); // 7 = Error BiMovil
                respuesta.Descripcion = $"{respuesta.Descripcion} {resultado.Mensaje}";
                return respuesta;
            }

            return new ReposicionPinResponseDto { CodigoInt = 0, Descripcion = "Exitoso" };
        }

        private async Task<ReposicionPinResponseDto> EnviarEmailAsync(TarjetaModel tarjeta, ReposicionPinRequestDto request, string pin)
        {
            long numeroTransaccion = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
            string referencia = numeroTransaccion.ToString();

            var resultado = await _envioEmailRepository.EnviarCorreoAsync(
                request.Correo,
                request.ContenidoCorreo,
                pin,
                referencia,
                CancellationToken.None
            );

            await InsertarRegistroEnvioEmailAsync(
                tarjeta,
                request,
                referencia,
                resultado.Codigo,
                resultado.Mensaje,
                resultado.MailFrom,
                resultado.MailSubject
            );

            if (resultado.Codigo != 0)
            {
                var respuesta = await ObtenerRespuestaCatalogoAsync(8); // 8 = Error Email
                respuesta.Descripcion = $"{respuesta.Descripcion} {resultado.Mensaje}";
                return respuesta;
            }

            return new ReposicionPinResponseDto { CodigoInt = 0, Descripcion = "Exitoso" };
        }

        private async Task InsertarRegistroEnvioSmsAsync(TarjetaModel tarjeta, ReposicionPinRequestDto request, string referencia, int codigo, string mensaje)
        {
            try
            {
                var entidad = new BandejaEnvioSmsModel
                {
                    NumeroTarjeta = tarjeta.NumeroTarjeta,
                    Celular = request.Telefono,
                    Telco = request.OperadorTelefono,
                    Sms = request.ContenidoSMS,
                    Referencia = referencia,
                    FechaInicio = DateTime.Now,
                    FechaFinal = DateTime.Now,
                    Estado = codigo,
                    DescripcionEstado = mensaje
                };

                await _bandejaSmsRepository.AddAsync(entidad);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error registrando resultado SMS");
            }
        }

        private async Task InsertarRegistroEnvioEmailAsync(
            TarjetaModel tarjeta,
            ReposicionPinRequestDto request,
            string referencia,
            int codigo,
            string mensaje,
            string mailFrom,
            string mailSubject)
        {
            try
            {
                var entidad = new BandejaEnvioEmailModel
                {
                    NumeroTarjeta = tarjeta.NumeroTarjeta,
                    CuerpoCorreo = request.ContenidoCorreo,
                    MailFrom = mailFrom,
                    MailSubject = mailSubject,
                    Correo = request.Correo,
                    Referencia = referencia,
                    FechaInicio = DateTime.Now,
                    FechaFinal = DateTime.Now,
                    Estado = codigo,
                    DescripcionEstado = mensaje
                };

                await _bandejaEmailRepository.AddAsync(entidad);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error registrando resultado Email");
            }
        }

        private async Task<ReposicionPinResponseDto> ObtenerRespuestaCatalogoAsync(int codigo)
        {
            string descripcion = null;
            try
            {
                var catalogoDescripcion = await _catalogoRepository.ObtenerDescripcionAsync(codigo);
                if (!string.IsNullOrWhiteSpace(catalogoDescripcion))
                    descripcion = catalogoDescripcion;
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, $"No se pudo obtener descripción del catálogo para código {codigo}");
            }

            return new ReposicionPinResponseDto
            {
                CodigoInt = codigo,
                Descripcion = descripcion
            };
        }
        #endregion
    }
}



Estado = 
DescripcionEstado = 


Pero parece que está tomando otra cosa
