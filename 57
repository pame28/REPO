public async Task<ReposicionPinResponseDto> ProcesarAsync(ReposicionPinRequestDto request)
{
    try
    {
        // 1️⃣ Validar request
        var errorValidacion = await _validator.ValidarAsync(request);
        if (errorValidacion != null)
            return errorValidacion;

        // 2️⃣ Obtener tarjeta
        var tarjeta = await _tarjetaRepository.ObtenerTarjetaAsync(request.CIF, request.UltimosDigitosTC);

        // 3️⃣ Consumir AS400
        var as400Request = new AS400RequestDto
        {
            NumeroTarjeta = tarjeta.NumeroTarjeta.PadLeft(16, ' '),
            FechaVencimiento = tarjeta.FechaFinVigencia.ToString("yyyyMMdd")
        };

        var as400Response = await _as400Repository.EjecutarProgramaAsync(as400Request);

        if (!string.IsNullOrWhiteSpace(as400Response.CodigoError) &&
            as400Response.CodigoError.Trim() != "00")
        {
            return await _respuestaService.MapearErrorAs400Async(as400Response);
        }

        // 4️⃣ Generación de PIN exitosa
        var respuesta = await _respuestaService.ObtenerRespuestaAsync(0);

        // 5️⃣ Notificación (SMS o Email)
        var resultadoNotificacion = await _notificacionService.EnviarAsync(
            tarjeta,
            request,
            as400Response.Pin
        );

        // 6️⃣ Si hubo error de notificación, agregamos info al mensaje pero el código principal sigue siendo 0
        if (resultadoNotificacion.Codigo != 0)
        {
            respuesta.Descripcion += resultadoNotificacion.Codigo switch
            {
                7 => $". SMS: {resultadoNotificacion.Mensaje}",
                8 => $". Correo: {resultadoNotificacion.Mensaje}",
                _ => $". Notificación: {resultadoNotificacion.Mensaje}"
            };
        }

        // 7️⃣ Devolver PIN y mensaje
        respuesta.Pin = as400Response.Pin;
        return respuesta;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error general en reposición PIN");
        return await _respuestaService.ObtenerRespuestaDinamicaAsync(
            99,
            "Excepción",
            ex.Message
        );
    }
}












using reposicion_pin.DTOs;
using reposicion_pin.Models;
using reposicion_pin.Repository.Interface;
using reposicion_pin.Service.Interface;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Configuration;
using System;
using System.Threading;
using System.Threading.Tasks;

namespace reposicion_pin.Service
{
    public class ReposicionPinNotificacionService : IReposicionPinNotificacionService
    {
        private readonly IEnvioSmsRepository _sms;
        private readonly IEnvioEmailRepository _email;
        private readonly IBandejaEnvioSmsRepository _bandejaSms;
        private readonly IBandejaEnvioEmailRepository _bandejaEmail;
        private readonly IConfiguration _configuration;
        private readonly ILogger<ReposicionPinNotificacionService> _logger;

        public ReposicionPinNotificacionService(
            IEnvioSmsRepository sms,
            IEnvioEmailRepository email,
            IBandejaEnvioSmsRepository bandejaSms,
            IBandejaEnvioEmailRepository bandejaEmail,
            IConfiguration configuration,
            ILogger<ReposicionPinNotificacionService> logger)
        {
            _sms = sms;
            _email = email;
            _bandejaSms = bandejaSms;
            _bandejaEmail = bandejaEmail;
            _configuration = configuration;
            _logger = logger;
        }

        public async Task<(int Codigo, string Mensaje)> EnviarAsync(
            TarjetaModel tarjeta,
            ReposicionPinRequestDto request,
            string pin)
        {
            string referencia = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds().ToString();

            try
            {
                if (request.MetodoEnvio == 1)
                {
                    // Enviar SMS
                    var resultadoSms = await _sms.EnviarSmsDirectoAsync(
                        request.Telefono,
                        request.OperadorTelefono,
                        request.ContenidoSMS.Replace("@PIN", pin),
                        pin,
                        referencia,
                        CancellationToken.None
                    );

                    // Guardar en bandeja
                    await _bandejaSms.AddAsync(new BandejaEnvioSmsModel
                    {
                        NumeroTarjeta = tarjeta.NumeroTarjeta,
                        Celular = request.Telefono,
                        Telco = request.OperadorTelefono,
                        Sms = request.ContenidoSMS,
                        Referencia = referencia,
                        FechaInicio = DateTime.Now,
                        FechaFinal = DateTime.Now,
                        Estado = resultadoSms.Codigo != 0 ? 7 : 0,
                        DescripcionEstado = resultadoSms.Mensaje
                    });

                    return (resultadoSms.Codigo != 0 ? 7 : 0, resultadoSms.Mensaje);
                }
                else if (request.MetodoEnvio == 2)
                {
                    // Enviar Email
                    var resultadoEmail = await _email.EnviarCorreoAsync(
                        request.Correo,
                        request.ContenidoCorreo.Replace("@PIN", pin),
                        pin,
                        referencia,
                        CancellationToken.None
                    );

                    // Guardar en bandeja
                    await _bandejaEmail.AddAsync(new BandejaEnvioEmailModel
                    {
                        NumeroTarjeta = tarjeta.NumeroTarjeta,
                        CuerpoCorreo = request.ContenidoCorreo,
                        MailFrom = resultadoEmail.MailFrom,
                        MailSubject = resultadoEmail.MailSubject,
                        Correo = request.Correo,
                        Referencia = referencia,
                        FechaInicio = DateTime.Now,
                        FechaFinal = DateTime.Now,
                        Estado = resultadoEmail.Codigo != 0 ? 8 : 0,
                        DescripcionEstado = resultadoEmail.Mensaje
                    });

                    return (resultadoEmail.Codigo != 0 ? 8 : 0, resultadoEmail.Mensaje);
                }

                return (10, "Método de envío no soportado");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error enviando notificación Ref:{Referencia}", referencia);
                return (99, $"Error al enviar notificación: {ex.Message}");
            }
        }
    }
}









using reposicion_pin.DTOs;
using reposicion_pin.Models;
using System.Threading.Tasks;

namespace reposicion_pin.Service.Interface
{
    public interface IReposicionPinNotificacionService
    {
        /// <summary>
        /// Envía la notificación (SMS o correo) según request.
        /// Devuelve un código de error interno (7 = SMS fallido, 8 = Email fallido, 0 = éxito, 99 = error general)
        /// y el mensaje correspondiente.
        /// </summary>
        Task<(int Codigo, string Mensaje)> EnviarAsync(TarjetaModel tarjeta, ReposicionPinRequestDto request, string pin);
    }
}