using reposicion_pin.DTOs;
using reposicion_pin.Repository.Interface;
using System.Data;
using System.Data.Odbc;

namespace reposicion_pin.Repository
{
    public class AS400RepositoryODBC_SP : IAS400Repository
    {
        private readonly string _as400ConnectionString;
        private readonly ILogger<AS400RepositoryODBC_SP> _logger;

        public AS400RepositoryODBC_SP(IConfiguration configuration, ILogger<AS400RepositoryODBC_SP> logger)
        {
            _as400ConnectionString = configuration.GetConnectionString("AS400Connection")!;
            _logger = logger;
        }

        public async Task<AS400ResponseDto> EjecutarProgramaAsync(AS400RequestDto request)
        {
            try
            {
                using var conn = new OdbcConnection(_as400ConnectionString);
                await conn.OpenAsync();

                // Construir la trama
                string trama = request.NumeroTarjeta.PadRight(16) +
                               request.FechaVencimiento.PadRight(8) +
                               new string(' ', 57);

                _logger.LogInformation("Trama enviada: {Trama}", trama);

                // üîπ Intento 1: llamar SP y leer como ResultSet
                using var cmd = conn.CreateCommand();
                cmd.CommandText = "SELECT V_INFO FROM BPPGM.SBP720P.SP_REIMQ07RC(?)";
                cmd.CommandType = CommandType.Text;

                var param = new OdbcParameter
                {
                    OdbcType = OdbcType.Char,
                    Size = 81,
                    Direction = ParameterDirection.Input,
                    Value = trama
                };
                cmd.Parameters.Add(param);

                string tramaRespuesta = string.Empty;

                using var reader = await cmd.ExecuteReaderAsync();
                if (await reader.ReadAsync())
                {
                    tramaRespuesta = reader.GetString(0)?.TrimEnd() ?? string.Empty;
                }

                _logger.LogInformation("Trama respuesta SP: {Trama}", tramaRespuesta);

                return ParsearRespuesta(tramaRespuesta);
            }
            catch (OdbcException ex)
            {
                _logger.LogError(ex, "Error ODBC AS400 SP");
                return new AS400ResponseDto
                {
                    CodigoError = "P98",
                    DescripcionError = ex.Message
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error general AS400 SP");
                return new AS400ResponseDto
                {
                    CodigoError = "P99",
                    DescripcionError = ex.Message
                };
            }
        }

        private static AS400ResponseDto ParsearRespuesta(string trama)
        {
            if (string.IsNullOrWhiteSpace(trama))
            {
                return new AS400ResponseDto
                {
                    CodigoError = "99",
                    DescripcionError = "TRAMA RESPUESTA INV√ÅLIDA"
                };
            }

            trama = trama.PadRight(81);

            string pin = trama.Substring(24, 4).Trim();
            string codigoError = trama.Substring(28, 3).Trim();
            string descripcionError = trama.Substring(31, 50).Trim();

            if (!string.IsNullOrWhiteSpace(pin) &&
                string.IsNullOrWhiteSpace(codigoError) &&
                string.IsNullOrWhiteSpace(descripcionError))
            {
                return new AS400ResponseDto
                {
                    Pin = pin,
                    CodigoError = "00",
                    DescripcionError = "Pin generado exitosamente"
                };
            }

            if (!string.IsNullOrWhiteSpace(codigoError))
            {
                return new AS400ResponseDto
                {
                    Pin = null,
                    CodigoError = codigoError,
                    DescripcionError = descripcionError
                };
            }

            return new AS400ResponseDto
            {
                CodigoError = "99",
                DescripcionError = "Respuesta desconocida AS400"
            };
        }
    }
}