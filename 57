using Microsoft.AspNetCore.Mvc;
using reposicion_pin.DTOs;
using reposicion_pin.Service;

namespace reposicion_pin.Controllers
{
    [Route("api")]
    [ApiController]
    public class ReposicionPinController : ControllerBase
    {
        private readonly ReposicionPinService _service;
        private readonly ILogger<ReposicionPinController> _logger;

        public ReposicionPinController(
            ReposicionPinService service,
            ILogger<ReposicionPinController> logger)
        {
            _service = service;
            _logger = logger;
        }

        [HttpPost]
        [Route("reposicion-pin")]
        public async Task<ActionResult<ReposicionPinResponseDto>> GenerarPin([FromBody] ReposicionPinRequestDto request)
        {
            try
            {
                // Procesar todo en el service (validación, AS400, notificación)
                var response = await _service.ProcesarAsync(request);

                return Ok(response);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error inesperado en GenerarPin");

                // Código 99 para errores no controlados
                return Ok(new ReposicionPinResponseDto
                {
                    CodigoInt = 99,
                    Descripcion = $"Error inesperado: {ex.Message}"
                });
            }
        }
    }
}