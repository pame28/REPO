public async Task<int> EnviarAsync(
    TarjetaModel tarjeta,
    ReposicionPinRequestDto request,
    string pin)
{
    string referencia = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds().ToString();

    try
    {
        if (request.MetodoEnvio == 1)
        {
            var resultadoSms = await _sms.EnviarSmsDirectoAsync(
                request.Telefono,
                request.OperadorTelefono,
                request.ContenidoSMS.Replace("@PIN", pin),
                pin,
                referencia,
                CancellationToken.None
            );

            // Guardar en bandeja
            await _bandejaSms.AddAsync(new BandejaEnvioSmsModel
            {
                NumeroTarjeta = tarjeta.NumeroTarjeta,
                Celular = request.Telefono,
                Telco = request.OperadorTelefono,
                Sms = request.ContenidoSMS,
                Referencia = referencia,
                FechaInicio = DateTime.Now,
                FechaFinal = DateTime.Now,
                Estado = resultadoSms.Codigo != 0 ? 7 : 0,
                DescripcionEstado = resultadoSms.Mensaje
            });

            return resultadoSms.Codigo != 0 ? 7 : 0;
        }
        else if (request.MetodoEnvio == 2)
        {
            var resultadoEmail = await _email.EnviarCorreoAsync(
                request.Correo,
                request.ContenidoCorreo.Replace("@PIN", pin),
                pin,
                referencia,
                CancellationToken.None
            );

            // Guardar en bandeja
            await _bandejaEmail.AddAsync(new BandejaEnvioEmailModel
            {
                NumeroTarjeta = tarjeta.NumeroTarjeta,
                CuerpoCorreo = request.ContenidoCorreo,
                MailFrom = resultadoEmail.MailFrom,
                MailSubject = resultadoEmail.MailSubject,
                Correo = request.Correo,
                Referencia = referencia,
                FechaInicio = DateTime.Now,
                FechaFinal = DateTime.Now,
                Estado = resultadoEmail.Codigo != 0 ? 8 : 0,
                DescripcionEstado = resultadoEmail.Mensaje
            });

            return resultadoEmail.Codigo != 0 ? 8 : 0;
        }

        return 10; // m√©todo no soportado
    }
    catch
    {
        return 99; // error general
    }
}