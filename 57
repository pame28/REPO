Tengo problemas en mi controller debido a las modificaciones que hicimos en el service:


using Microsoft.AspNetCore.Mvc;
using reposicion_pin.DTOs;
using reposicion_pin.Service;

// For more information on enabling Web API for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860

namespace reposicion_pin.Controllers
{
    [Route("api")]
    [ApiController]
    public class ReposicionPinController : ControllerBase
    {
        private readonly ReposicionPinService _service;

        public ReposicionPinController(ReposicionPinService service)
        {
            _service = service;
        }

        [HttpPost]
        [Route("reposicion-pin")]
        public async Task<ActionResult<ReposicionPinResponseDto>> GenerarPin([FromBody] ReposicionPinRequestDto request)
        {
            // Validar Tarjeta
            var validarTarjeta = await _service.ValidarTarjetaAsync(request);
            if (validarTarjeta.CodigoInt != 0)
                return Ok(validarTarjeta);

            // Obtener tarjeta y parámetros de la BD
            var tarjeta = await _service.ObtenerTarjetaAsync(request.CIF, request.UltimosDigitosTC);
            if (tarjeta == null)
                return Ok(await _service.ObtenerRespuestaAsync(5));

            // Consumir AS400
            var consumoAS400 = await _service.ConsumirAs400Async(tarjeta, request);

            return Ok(consumoAS400);
        }
    }
}   







Este es el service ahora:

using reposicion_pin.DTOs;
using reposicion_pin.Models;
using reposicion_pin.Repository.Interface;
using reposicion_pin.Service.Interface;

namespace reposicion_pin.Service
{
    public class ReposicionPinService
    {
        private readonly ITarjetaRepository _tarjetaRepository;
        private readonly IAS400Repository _as400Repository;
        private readonly IReposicionPinValidator _validator;
        private readonly IReposicionPinNotificacionService _notificacionService;
        private readonly IReposicionPinRespuestaService _respuestaService;
        private readonly ILogger<ReposicionPinService> _logger;

        public ReposicionPinService(
            ITarjetaRepository tarjetaRepository,
            IAS400Repository as400Repository,
            IReposicionPinValidator validator,
            IReposicionPinNotificacionService notificacionService,
            IReposicionPinRespuestaService respuestaService,
            ILogger<ReposicionPinService> logger)
        {
            _tarjetaRepository = tarjetaRepository;
            _as400Repository = as400Repository;
            _validator = validator;
            _notificacionService = notificacionService;
            _respuestaService = respuestaService;
            _logger = logger;
        }

        public async Task<ReposicionPinResponseDto> ProcesarAsync(ReposicionPinRequestDto request)
        {
            try
            {
                // 1️⃣ Validar request
                var errorValidacion = await _validator.ValidarAsync(request);
                if (errorValidacion != null)
                    return errorValidacion;

                // 2️⃣ Obtener tarjeta
                var tarjeta = await _tarjetaRepository
                    .ObtenerTarjetaAsync(request.CIF, request.UltimosDigitosTC);

                // 3️⃣ Consumir AS400
                var as400Request = new AS400RequestDto
                {
                    NumeroTarjeta = tarjeta.NumeroTarjeta.PadLeft(16, ' '),
                    FechaVencimiento = tarjeta.FechaFinVigencia.ToString("yyyyMMdd")
                };

                var as400Response = await _as400Repository.EjecutarProgramaAsync(as400Request);

                if (!string.IsNullOrWhiteSpace(as400Response.CodigoError) &&
                    as400Response.CodigoError.Trim() != "00")
                {
                    return await _respuestaService.MapearErrorAs400Async(as400Response);
                }

                //  Notificar (SMS o Email)
                await _notificacionService.EnviarAsync(
                    tarjeta,
                    request,
                    as400Response.Pin
                );

                //  Respuesta exitosa
                return await _respuestaService.ObtenerRespuestaAsync(0, as400Response.Pin);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error general en reposición PIN");
                return await _respuestaService.ObtenerRespuestaDinamicaAsync(
                    99,
                    "Excepción",
                    ex.Message
                );
            }
        }
    }
}

