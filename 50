using reposicion_pin.DTOs;
using reposicion_pin.Repository.Interface;
using System.Configuration;
using System.Data;
using System.Data.OleDb;
using static Microsoft.EntityFrameworkCore.DbLoggerCategory;

namespace reposicion_pin.Repository
{
    public class AS400Repository : IAS400Repository
    {
        private readonly string _as400connectionString;
        private readonly ILogger<AS400Repository> _logger;
        private readonly IConfiguracionAs400Repository _configAs400Repository;

        public AS400Repository(
            IConfiguration configuration,
            ILogger<AS400Repository> logger,
            IConfiguracionAs400Repository configAs400Repository
            )
        {
            _as400connectionString = configuration.GetConnectionString("AS400Connection")!;
            _logger = logger;
            _configAs400Repository = configAs400Repository;
        }

        public async Task<AS400ResponseDto> EjecutarProgramaAsync(AS400RequestDto request)
        {
            try
            {
                using var conn = new OleDbConnection(_as400connectionString);
                await conn.OpenAsync();


                //await ConfigurarLibraryListAsync(conn);
                var config = await _configAs400Repository.ObtenerConfiguracionAsync(1);
                await ConfigurarLibraryListAsync(conn, config.librerias);

                string trama =
                    request.NumeroTarjeta.PadRight(16) +
                    request.FechaVencimiento.PadRight(8) +
                    new string(' ', 57);

                _logger.LogInformation("Trama enviada AS400: {Trama}", trama);


                using var cmd = conn.CreateCommand();
                cmd.CommandType = CommandType.Text;
                cmd.CommandTimeout = 300;

                // CALL cl√°sico como en el sistema legacy
                cmd.CommandText = config.call;

                var paramTrama = new OleDbParameter
                {
                    ParameterName = "peTramaMQRcv",
                    OleDbType = OleDbType.Char,
                    Size = 81,
                    Direction = ParameterDirection.InputOutput,
                    Value = trama
                };

                cmd.Parameters.Add(paramTrama);

                await cmd.ExecuteNonQueryAsync();

                string tramaRespuesta = paramTrama.Value?.ToString() ?? string.Empty;
                _logger.LogInformation("Trama respuesta AS400: {Trama}", tramaRespuesta);

                return ParsearRespuesta(tramaRespuesta);

            }
            catch (OleDbException ex)
            {
                _logger.LogError(ex, "Error OLE DB AS400");

                return new AS400ResponseDto
                {
                    CodigoError = "P98",
                    DescripcionError = ex.Message
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error general AS400");

                return new AS400ResponseDto
                {
                    CodigoError = "P99",
                    DescripcionError = ex.Message
                };
            }
        }

        private async Task ConfigurarLibraryListAsync(OleDbConnection conn, List<string> librerias)
        {
            using var cmd = conn.CreateCommand();
            cmd.CommandType = CommandType.Text;
            cmd.CommandTimeout = 300;

            // Limpia el LIBL
            cmd.CommandText =
                "{{CALL PGM(QSYS/QCMDEXC) PARM('CHGLIBL LIBL(*NONE)' 30)}}";
            await cmd.ExecuteNonQueryAsync();

      
         

            foreach (var lib in librerias)
            {
                cmd.CommandText =
                    $"{{{{CALL PGM(QSYS/QCMDEXC) PARM('ADDLIBLE LIB({lib})' 30)}}}}";
                await cmd.ExecuteNonQueryAsync();
            }
        }

        private static AS400ResponseDto ParsearRespuesta(string trama)
        {
            if (string.IsNullOrWhiteSpace(trama))
            {
                return new AS400ResponseDto
                {
                    CodigoError = "99",
                    DescripcionError = "TRAMA RESPUESTA INV√ÅLIDA"
                };
            }

            trama = trama.PadRight(81);

            string pin = trama.Substring(24, 4).Trim();
            string codigoError = trama.Substring(28, 3).Trim();
            string descripcionError = trama.Substring(31, 50).Trim();

            // üîπ CASO EXITOSO: solo viene PIN
            if (!string.IsNullOrWhiteSpace(pin) &&
                string.IsNullOrWhiteSpace(codigoError) &&
                string.IsNullOrWhiteSpace(descripcionError))
            {
                return new AS400ResponseDto
                {
                    Pin = pin,
                    CodigoError = "00",
                    DescripcionError = "Pin generado exitosamente"
                };
            }

            // üîπ CASO ERROR
            if (!string.IsNullOrWhiteSpace(codigoError))
            {
                return new AS400ResponseDto
                {
                    Pin = null,
                    CodigoError = codigoError,
                    DescripcionError = descripcionError
                };
            }

            return new AS400ResponseDto
            {
                CodigoError = "99",
                DescripcionError = "Respuesta desconocida AS400"
            };
        }
    }
}








using reposicion_pin.DTOs;
using reposicion_pin.Models;
using reposicion_pin.Repository;
using reposicion_pin.Repository.Interface;
using reposicion_pin.Service.Interface;
using System.ComponentModel.DataAnnotations;
using System.Text.RegularExpressions;

namespace reposicion_pin.Service
{
    public class ReposicionPinService
    {
        private readonly ITarjetaRepository _tarjetaRepository;
        private readonly ICatalogoRespuestaRepository _catalogoRepository;
        private readonly IAS400Repository _as400Repository;
        private readonly ILogger<ReposicionPinService> _logger;

        public ReposicionPinService(
            ITarjetaRepository tarjetaRepository,
            ICatalogoRespuestaRepository catalogoRepository,
            IAS400Repository as400Repository,
            ILogger<ReposicionPinService> logger)
        {
            _tarjetaRepository = tarjetaRepository;
            _catalogoRepository = catalogoRepository;
            _as400Repository = as400Repository;
            _logger = logger;
        }

        #region FASE 1 - Validar tarjeta
        public async Task<ReposicionPinResponseDto> ValidarTarjetaAsync(ReposicionPinRequestDto request)
        {
            try
            {
                // Validaciones b√°sicas del request
                if (string.IsNullOrWhiteSpace(request.CIF))
                    return await ObtenerRespuestaDinamicaAsync(10, "CIF", "Se encuentra vac√≠o o inv√°lido");

                if (string.IsNullOrWhiteSpace(request.UltimosDigitosTC))
                    return await ObtenerRespuestaDinamicaAsync(10, "UltimosDigitosTC", " Se encuentra vac√≠o o inv√°lido");

                if (request.MetodoEnvio != 1 && request.MetodoEnvio != 2)
                    return await ObtenerRespuestaDinamicaAsync(10, "MetodoEnvio", "Debe ser 1 (SMS) o 2 (Correo)");

                if (request.MetodoEnvio == 1) // SMS
                {
                    if (string.IsNullOrWhiteSpace(request.Telefono))
                        return await ObtenerRespuestaDinamicaAsync(10, "Telefono", "Es obligatorio para MetodoEnvio=1 (SMS)");
                    else if (string.IsNullOrWhiteSpace(request.ContenidoSMS))
                        return await ObtenerRespuestaDinamicaAsync(10, "Contenido SMS", "Es obligatorio para MetodoEnvio=1 (SMS)");
                }
                else if (request.MetodoEnvio == 2) // Correo
                {
                    if (string.IsNullOrWhiteSpace(request.Correo) || !request.Correo.Contains("@"))
                        return await ObtenerRespuestaDinamicaAsync(10, "Correo", "Es obligatorio y debe ser v√°lido para MetodoEnvio=2 (Correo)");
                    else if (string.IsNullOrWhiteSpace(request.ContenidoCorreo))
                        return await ObtenerRespuestaDinamicaAsync(10, "Contenido Correo", "Es obligatorio para MetodoEnvio=2 (Correo)");
                }

                // Buscar tarjeta en BD
                var tarjeta = await _tarjetaRepository.ObtenerTarjetaAsync(request.CIF, request.UltimosDigitosTC);
                if (tarjeta == null)
                    return await ObtenerRespuestaAsync(5); // No se encontr√≥ tarjeta

                // Validaciones de tarjeta
                if (tarjeta.EstadoTarjeta != 20)
                    return await ObtenerRespuestaAsync(1); // Tarjeta inactiva

                if (tarjeta.FechaFinVigencia < DateTime.Today)
                    return await ObtenerRespuestaAsync(2); // Tarjeta vencida

                if (!string.IsNullOrWhiteSpace(tarjeta.EstadoHabilitar))
                    return await ObtenerRespuestaDinamicaAsync(10, "EstadoHabilitar", "debe estar vac√≠o");

                // Todo ok
                return await ObtenerRespuestaAsync(0);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error inesperado en Fase1 de ReposicionPinService");
                return await ObtenerRespuestaDinamicaAsync(99, "Excepci√≥n", ex.Message);
            }
        }
        #endregion

        #region Nuevo m√©todo p√∫blico para que controller pueda usarlo
        public async Task<TarjetaModel?> ObtenerTarjetaAsync(string cif, string ultimosDigitos)
        {
            return await _tarjetaRepository.ObtenerTarjetaAsync(cif, ultimosDigitos);
        }
        #endregion

        #region FASE 2 - Consumir AS400
        public async Task<ReposicionPinResponseDto> Fase2_ConsumirAs400Async(TarjetaModel tarjeta)
        {
            try
            {
                var as400Request = new AS400RequestDto
                {
                    NumeroTarjeta = tarjeta.NumeroTarjeta.PadLeft(16, ' '),
                    FechaVencimiento = tarjeta.FechaFinVigencia.ToString("yyyyMMdd")
                };

                var as400Response = await _as400Repository.EjecutarProgramaAsync(as400Request);

                var codigoAs400 = as400Response.CodigoError?.Trim();


                // Si hay error de AS400
                if (!string.IsNullOrWhiteSpace(codigoAs400) && codigoAs400 != "00")
                    return await MapearErrorAs400Async(as400Response);

                // Todo OK
                //    return new ReposicionPinResponseDto
                //    {
                //        CodigoInt = 0,
                //        Descripcion = "Pin generado exitosamente",
                //        Pin = as400Response.Pin
                //    };


                var respuesta = await ObtenerRespuestaAsync(0);
                respuesta.Pin = as400Response.Pin;
                return respuesta;

            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error inesperado en Fase2 al consumir AS400");
                return await ObtenerRespuestaDinamicaAsync(99, "Excepci√≥n", ex.Message);
            }
        }


        //private async Task<ReposicionPinResponseDto>MapearErrorAs400Async(AS400ResponseDto as400)
        //{
        //    if (!int.TryParse(as400.CodigoError, out int codigo))
        //        codigo = 99;

        //    return await ObtenerRespuestaAsync(codigo);
        //}

        private async Task<ReposicionPinResponseDto> MapearErrorAs400Async(AS400ResponseDto as400)
        {
            // Siempre ser√° c√≥digo 9 seg√∫n cat√°logo oficial
            var respuesta = await ObtenerRespuestaAsync(9);

            string codigoAs400 = as400.CodigoError?.Trim() ?? "";
            string descripcionAs400 = as400.DescripcionError?.Trim() ?? "";

            respuesta.Descripcion = $"{respuesta.Descripcion} {codigoAs400} {descripcionAs400}".Trim();
            respuesta.Pin = null;

            return respuesta;
        }
        #endregion

        #region Helpers de respuestas
        public async Task<ReposicionPinResponseDto> ObtenerRespuestaAsync(int codigo, string fallbackDescripcion = null)
        {
            string descripcion = fallbackDescripcion;
            try
            {
                var catalogoDescripcion = await _catalogoRepository.ObtenerDescripcionAsync(codigo);
                if (!string.IsNullOrWhiteSpace(catalogoDescripcion))
                    descripcion = catalogoDescripcion;
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, $"No se pudo obtener descripci√≥n del catalogo para c√≥digo {codigo}");
            }

            return new ReposicionPinResponseDto
            {
                CodigoInt = codigo,
                Descripcion = descripcion
            };
        }

        public async Task<ReposicionPinResponseDto> ObtenerRespuestaDinamicaAsync(int codigo, string campo, string detalle, string fallbackDescripcion = null)
        {
            string descripcion = fallbackDescripcion;
            try
            {
                var catalogoDescripcion = await _catalogoRepository.ObtenerDescripcionAsync(codigo);
                if (!string.IsNullOrWhiteSpace(catalogoDescripcion))
                    descripcion = catalogoDescripcion;
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, $"No se pudo obtener descripci√≥n del cat√°logo para c√≥digo {codigo}");
            }

            string mensajeFinal = $"{descripcion ?? "Error"} {campo}: {detalle}";
            return new ReposicionPinResponseDto
            {
                CodigoInt = codigo,
                Descripcion = mensajeFinal
            };
        }
        #endregion
    }

}



using Microsoft.AspNetCore.Mvc;
using reposicion_pin.DTOs;
using reposicion_pin.Service;

// For more information on enabling Web API for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860

namespace reposicion_pin.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class ReposicionPinController : ControllerBase
    {
        private readonly ReposicionPinService _service;

        public ReposicionPinController(ReposicionPinService service)
        {
            _service = service;
        }

        [HttpPost]
        [Route("validar-tarjeta")]
        public async Task<ActionResult<ReposicionPinResponseDto>> ValidarTarjeta([FromBody] ReposicionPinRequestDto request)
        {
            var result = await _service.ValidarTarjetaAsync(request);
            return Ok(result);
        }

        /// <summary>
        /// Fase 2: Consumir AS400 para generar PIN
        /// </summary>
        [HttpPost]
        [Route("generar-pin")]
        public async Task<ActionResult<ReposicionPinResponseDto>> GenerarPin([FromBody] ReposicionPinRequestDto request)
        {
            // 1Ô∏è‚É£ Validar la tarjeta (fase 1)
            var fase1 = await _service.ValidarTarjetaAsync(request);
            if (fase1.CodigoInt != 0)
                return Ok(fase1);

            // 2Ô∏è‚É£ Obtener tarjeta de BD usando el m√©todo p√∫blico del servicio
            var tarjeta = await _service.ObtenerTarjetaAsync(request.CIF, request.UltimosDigitosTC);
            if (tarjeta == null)
                return Ok(await _service.ObtenerRespuestaDinamicaAsync(5, "Tarjeta", "No se encontr√≥ tarjeta"));

            // 3Ô∏è‚É£ Consumir AS400
            var fase2 = await _service.Fase2_ConsumirAs400Async(tarjeta);

            return Ok(fase2);
        }
    }
}   







