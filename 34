using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace reposicion_pin.Models
{
    [Table("Tarjetas")]
    public class TarjetaModel
    {
        [Key]
        public int Id {  get; set; }
        public string EquivalenteTC { get; set; } = string.Empty;

        public string CIF { get; set; }=string.Empty;
        public DateTime FechaFinVigencia { get; set; }
        public short EstadoTarjeta { get; set; }
        public string EstadoHabilitar { get; set; } = string.Empty;
    }
}




namespace reposicion_pin.Models
{
    public class ConfigBiMovil
    {
        public int Id { get; set; }
        public string UserBiMovil { get; set; }
        public string PassBiMovil { get; set; }
    }
}


using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace reposicion_pin.Models
{
    [Table ("CatalogoRespuestas")]
    public class CatalogoRespuestaModel
    {
        [Key]
        [Column("Codigo")]
        public int Codigo { get; set; }
        public string Descripcion { get; set; }=string.Empty;
    }
}


namespace reposicion_pin.Models
{
    public class BandejaEnvio
    {
        public int IdRow { get; set; }
        public string Celular { get; set; }
        public string Email { get; set; }
        public string Mensaje { get; set; }
        public int MetodoEnvio { get; set; } // 1 = SMS | 2 = EMAIL
        public int Estado { get; set; } // 0 pendiente | 1 enviado | 2 fallido | 3 error
        public string Referencia { get; set; }
        public DateTime? FechaFinal { get; set; }
        public string DescripcionEstado { get; set; }
    }
}



using Microsoft.EntityFrameworkCore;
using reposicion_pin.Models;

namespace reposicion_pin.Infrastructure.Data
{
    public class AppDbContext: DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext>options):base (options) { }
        public DbSet<TarjetaModel> Tarjetas { get; set; } = null!;
        public DbSet<CatalogoRespuestaModel> CatalogoRespuestas { get; set; } = null!;
        public DbSet<BandejaEnvio> BandejaEnvio { get; set; }
        public DbSet<ConfigBiMovil> ConfigBiMovil { get; set; }
    }
}

using System.Text.Json.Serialization;

namespace reposicion_pin.DTOs
{
    public class ReposicionPinResponseDto
    {
        [JsonIgnore]
        public int CodigoInt { get; set; }
        public string Codigo => CodigoInt < 10 ? $"0{CodigoInt}" : CodigoInt.ToString();
        public string Descripcion { get; set; } = string.Empty;
        public string? Pin { get; set; }
    }
}


namespace reposicion_pin.DTOs
{
    public class ReposicionPinRequestDto
    {
        public string CIF { get; set; } = string.Empty;
        public string DNI { get; set; } = string.Empty;
        public string Cliente { get; set; } = string.Empty;
        public int MetodoEnvio { get; set; }
        public string Telefono { get; set; } = string.Empty;
        public string OperadorTelefono { get; set; } = string.Empty;
        public string Correo { get; set; } = string.Empty;
        public string UltimosDigitosTC { get; set; } = string.Empty;
        public string ContenidoSMS { get; set; } = string.Empty;
        public string ContenidoCorreo { get; set; } = string.Empty;
    }
}


namespace reposicion_pin.DTOs
{
    public class AS400RequestDto
    {
        public string EquivalenteTC {  get; set; }
        public string FechaVencimiento { get; set; }

    }
}


namespace reposicion_pin.DTOs
{
    public class AS400ResponseDto
    {
        public string Pin {  get; set; }
        public string CodigoError { get; set; }
        public string DescripcionError { get; set; }

    }
}



using Dapper;
using Microsoft.Data.SqlClient;
using Microsoft.EntityFrameworkCore;
using reposicion_pin.DTOs;
using reposicion_pin.Infrastructure.Data;
using reposicion_pin.Models;
using reposicion_pin.Repository.Interface;
using System.Data;

namespace reposicion_pin.Repository
{
    public class TarjetaRepository : ITarjetaRepository
    {
        private readonly AppDbContext _context;

        public TarjetaRepository(AppDbContext context)
        {
            _context = context;
        }

        public async Task<TarjetaModel?> ObtenerTarjetaAsync(string cif, string ultimosDigitos)
        {
            return await _context.Tarjetas
                .Where(t => t.CIF == cif && t.EquivalenteTC.EndsWith(ultimosDigitos))
                .FirstOrDefaultAsync();
        }
    }
}


using Microsoft.EntityFrameworkCore;
using reposicion_pin.Infrastructure.Data;
using reposicion_pin.Repository.Interface;

namespace reposicion_pin.Repository
{
    public class CatalogoRespuestaRepository : ICatalogoRespuestaRepository
    {
        private readonly AppDbContext _context;

        public CatalogoRespuestaRepository(AppDbContext context)
        {
            _context = context;
        }

        public async Task<string> ObtenerDescripcionAsync(int codigo)
        {
            var catalogo = await _context.CatalogoRespuestas
                .Where(c=> c.Codigo == codigo)
                .Select(c=>c.Descripcion)
                .FirstOrDefaultAsync();
            return catalogo;
        }
    }
}




using reposicion_pin.DTOs;
using reposicion_pin.Repository.Interface;
using System.Configuration;
using System.Data;
using System.Data.OleDb;
using static Microsoft.EntityFrameworkCore.DbLoggerCategory;

namespace reposicion_pin.Repository
{
    public class AS400Repository : IAS400Repository
    {
        private readonly string _connectionString;
        private readonly ILogger<AS400Repository> _logger;

        public AS400Repository(
            IConfiguration configuration,
            ILogger<AS400Repository> logger)
        {
            _connectionString = configuration.GetConnectionString("AS400Connection")!;
            _logger = logger;
        }

        public async Task<AS400ResponseDto> EjecutarProgramaAsync(AS400RequestDto request)
        {
            try
            {
                using var conn = new OleDbConnection(_connectionString);
                await conn.OpenAsync();

                // 1️⃣ Armar la trama (81)
                string trama =
                    request.EquivalenteTC.PadRight(16) +
                    request.FechaVencimiento.PadRight(8) +
                    new string(' ', 57);

                // 2️⃣ CALL directo al programa (SIN CHGLIBL)
                string sql = "CALL BPPGM/REIMQ07RC (?)";

                using var cmd = new OleDbCommand(sql, conn);
                cmd.CommandType = CommandType.Text;
                cmd.CommandTimeout = 300;

                var paramTrama = new OleDbParameter
                {
                    OleDbType = OleDbType.Char,
                    Size = 81,
                    Direction = ParameterDirection.InputOutput,
                    Value = trama
                };

                cmd.Parameters.Add(paramTrama);

                _logger.LogInformation("Ejecutando REIMQ07RC en AS400");
                _logger.LogDebug("Trama enviada: {Trama}", trama);

                await cmd.ExecuteNonQueryAsync();

                string tramaRespuesta = paramTrama.Value?.ToString() ?? string.Empty;

                return ParsearRespuesta(tramaRespuesta);
            }
            catch (OleDbException ex)
            {
                _logger.LogError(ex, "Error OleDb AS400");

                return new AS400ResponseDto
                {
                    CodigoError = "P98",
                    DescripcionError = "ERROR AL LLAMAR A MQ"
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error inesperado AS400");

                return new AS400ResponseDto
                {
                    CodigoError = "P99",
                    DescripcionError = "TRAMA NO ENCONTRADA"
                };
            }
        }

        private static AS400ResponseDto ParsearRespuesta(string trama)
        {
            if (trama.Length < 81)
            {
                return new AS400ResponseDto
                {
                    CodigoError = "P99",
                    DescripcionError = "TRAMA RESPUESTA INVÁLIDA"
                };
            }

            return new AS400ResponseDto
            {
                Pin = trama.Substring(24, 4).Trim(),
                CodigoError = trama.Substring(28, 3).Trim(),
                DescripcionError = trama.Substring(31, 50).Trim()
            };
        }
    }
}





using Microsoft.EntityFrameworkCore;
using reposicion_pin.Infrastructure.Data;
using reposicion_pin.Models;
using reposicion_pin.Repository.Interface;

namespace reposicion_pin.Repository
{
    public class BandejaEnvioRepository : IBandejaEnvioRepository
    {
        private readonly AppDbContext _db;

        public BandejaEnvioRepository(AppDbContext db)
        {
            _db = db;
        }

        public async Task<List<BandejaEnvio>> ObtenerPendientesAsync()
        {
            return await _db.BandejaEnvio
                .Where(x => x.Estado == 0)
                .ToListAsync();
        }

        public async Task ActualizarEstadoAsync(int id, int estado, string descripcion)
        {
            var item = await _db.BandejaEnvio.FindAsync(id);
            if (item == null) return;

            item.Estado = estado;
            item.DescripcionEstado = descripcion;
            item.FechaFinal = DateTime.Now;

            await _db.SaveChangesAsync();
        }
    }
}




using reposicion_pin.Models;
using reposicion_pin.Repository.Interface;

namespace reposicion_pin.Repository
{
    public class EnvioCorreoRepository : IEnvioCorreoRepository
    {
        public async Task EnviarAsync(BandejaEnvio item, CancellationToken ct)
        {
            // Placeholder realista
            await Task.Delay(300, ct);
            // Aquí iría SMTP / API correo
        }
    }
}




using reposicion_pin.Infrastructure.Data;
using reposicion_pin.Models;
using reposicion_pin.Repository.Interface;
using Serilog;
using System.Xml;

namespace reposicion_pin.Repository
{
    public class EnvioSmsRepository : IEnvioSmsRepository
    {
        private readonly MensajesSoapClient _soapClient;
        private readonly string _usr;
        private readonly string _pass;
        private readonly ILogger _log;

        public EnvioSmsRepository(AppDbContext db, ILogger log)
        {
            _log = log;
            _soapClient = new MensajesSoapClient(
                MensajesSoapClient.EndpointConfiguration.MensajesSoap
            );

            var cred = db.ConfigBiMovil.First();
            _usr = cred.UserBiMovil;
            _pass = cred.PassBiMovil;
        }

        public async Task EnviarAsync(BandejaEnvio item, CancellationToken ct)
        {
            var response = await _soapClient.Envia_MensajeAsync(
                _usr,
                _pass,
                item.Celular,
                "TIGO",
                item.Mensaje,
                item.Referencia,
                string.Empty,
                string.Empty
            );

            XmlDocument xml = new XmlDocument();
            xml.LoadXml(response.Envia_MensajeResult.Any1.InnerXml);

            var respuesta = xml.GetElementsByTagName("respuesta")[0].InnerText;
            var codigo = respuesta.Substring(0, 1);

            if (codigo != "0")
                throw new Exception(respuesta);
        }
    }
}




using reposicion_pin.DTOs;
using reposicion_pin.Models;
using reposicion_pin.Repository;
using reposicion_pin.Repository.Interface;
using reposicion_pin.Service.Interface;
using System.ComponentModel.DataAnnotations;
using System.Text.RegularExpressions;

namespace reposicion_pin.Service
{
    public class ReposicionPinService
    {
        private readonly ITarjetaRepository _tarjetaRepository;
        private readonly ICatalogoRespuestaRepository _catalogoRepository;
        private readonly IAS400Repository _as400Repository;
        private readonly ILogger<ReposicionPinService> _logger;

        public ReposicionPinService(
            ITarjetaRepository tarjetaRepository,
            ICatalogoRespuestaRepository catalogoRepository,
            IAS400Repository as400Repository,
            ILogger<ReposicionPinService> logger)
        {
            _tarjetaRepository = tarjetaRepository;
            _catalogoRepository = catalogoRepository;
            _as400Repository = as400Repository;
            _logger = logger;
        }

        #region FASE 1 - Validar tarjeta
        public async Task<ReposicionPinResponseDto> ValidarTarjetaAsync(ReposicionPinRequestDto request)
        {
            try
            {
                // Validaciones básicas del request
                if (string.IsNullOrWhiteSpace(request.CIF))
                    return await ObtenerRespuestaDinamicaAsync(10, "CIF", "Se encuentra vacío o inválido");

                if (string.IsNullOrWhiteSpace(request.UltimosDigitosTC))
                    return await ObtenerRespuestaDinamicaAsync(10, "UltimosDigitosTC", " Se encuentra vacío o inválido");

                if (request.MetodoEnvio != 1 && request.MetodoEnvio != 2)
                    return await ObtenerRespuestaDinamicaAsync(10, "MetodoEnvio", "Debe ser 1 (SMS) o 2 (Correo)");

                if (request.MetodoEnvio == 1) // SMS
                {
                    if (string.IsNullOrWhiteSpace(request.Telefono))
                        return await ObtenerRespuestaDinamicaAsync(10, "Telefono", "Es obligatorio para MetodoEnvio=1 (SMS)");
                    else if (string.IsNullOrWhiteSpace(request.ContenidoSMS))
                        return await ObtenerRespuestaDinamicaAsync(10, "Contenido SMS", "Es obligatorio para MetodoEnvio=1 (SMS)");
                }
                else if (request.MetodoEnvio == 2) // Correo
                {
                    if (string.IsNullOrWhiteSpace(request.Correo) || !request.Correo.Contains("@"))
                        return await ObtenerRespuestaDinamicaAsync(10, "Correo", "Es obligatorio y debe ser válido para MetodoEnvio=2 (Correo)");
                    else if (string.IsNullOrWhiteSpace(request.ContenidoCorreo))
                        return await ObtenerRespuestaDinamicaAsync(10, "Contenido Correo", "Es obligatorio para MetodoEnvio=2 (Correo)");
                }

                // Buscar tarjeta en BD
                var tarjeta = await _tarjetaRepository.ObtenerTarjetaAsync(request.CIF, request.UltimosDigitosTC);
                if (tarjeta == null)
                    return await ObtenerRespuestaAsync(5); // No se encontró tarjeta

                // Validaciones de tarjeta
                if (tarjeta.EstadoTarjeta != 20)
                    return await ObtenerRespuestaAsync(1); // Tarjeta inactiva

                if (tarjeta.FechaFinVigencia < DateTime.Today)
                    return await ObtenerRespuestaAsync(2); // Tarjeta vencida

                if (!string.IsNullOrWhiteSpace(tarjeta.EstadoHabilitar))
                    return await ObtenerRespuestaDinamicaAsync(10, "EstadoHabilitar", "debe estar vacío");

                // Todo ok
                return await ObtenerRespuestaAsync(0);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error inesperado en Fase1 de ReposicionPinService");
                return await ObtenerRespuestaDinamicaAsync(99, "Excepción", ex.Message);
            }
        }
        #endregion

        #region Nuevo método público para que controller pueda usarlo
        public async Task<TarjetaModel?> ObtenerTarjetaAsync(string cif, string ultimosDigitos)
        {
            return await _tarjetaRepository.ObtenerTarjetaAsync(cif, ultimosDigitos);
        }
        #endregion

        #region FASE 2 - Consumir AS400
        public async Task<ReposicionPinResponseDto> Fase2_ConsumirAs400Async(TarjetaModel tarjeta)
        {
            try
            {
                var as400Request = new AS400RequestDto
                {
                    EquivalenteTC = tarjeta.EquivalenteTC.PadLeft(16, ' '),
                    FechaVencimiento = tarjeta.FechaFinVigencia.ToString("yyyyMMdd")
                };

                var as400Response = await _as400Repository.EjecutarProgramaAsync(as400Request);

                // Si hay error de AS400
                if (!string.IsNullOrEmpty(as400Response.CodigoError?.Trim()))
                    return MapearErrorAs400(as400Response);

                // Todo OK
                return new ReposicionPinResponseDto
                {
                    CodigoInt = 0,
                    Descripcion = "Pin generado exitosamente",
                    Pin = as400Response.Pin
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error inesperado en Fase2 al consumir AS400");
                return await ObtenerRespuestaDinamicaAsync(99, "Excepción", ex.Message);
            }
        }

        private ReposicionPinResponseDto MapearErrorAs400(AS400ResponseDto as400)
        {
            string descripcion = $"Error en servicio AZ7: {as400.DescripcionError}";
            return new ReposicionPinResponseDto
            {
                CodigoInt = 9,
                Descripcion = descripcion,
                Pin = null
            };
        }
        #endregion

        #region Helpers de respuestas
        public async Task<ReposicionPinResponseDto> ObtenerRespuestaAsync(int codigo, string fallbackDescripcion = null)
        {
            string descripcion = fallbackDescripcion;
            try
            {
                var catalogoDescripcion = await _catalogoRepository.ObtenerDescripcionAsync(codigo);
                if (!string.IsNullOrWhiteSpace(catalogoDescripcion))
                    descripcion = catalogoDescripcion;
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, $"No se pudo obtener descripción del catalogo para código {codigo}");
            }

            return new ReposicionPinResponseDto
            {
                CodigoInt = codigo,
                Descripcion = descripcion
            };
        }

        public async Task<ReposicionPinResponseDto> ObtenerRespuestaDinamicaAsync(int codigo, string campo, string detalle, string fallbackDescripcion = null)
        {
            string descripcion = fallbackDescripcion;
            try
            {
                var catalogoDescripcion = await _catalogoRepository.ObtenerDescripcionAsync(codigo);
                if (!string.IsNullOrWhiteSpace(catalogoDescripcion))
                    descripcion = catalogoDescripcion;
            }
            catch (Exception ex)
            {
                _logger.LogWarning(ex, $"No se pudo obtener descripción del catálogo para código {codigo}");
            }

            string mensajeFinal = $"{descripcion ?? "Error"} {campo}: {detalle}";
            return new ReposicionPinResponseDto
            {
                CodigoInt = codigo,
                Descripcion = mensajeFinal
            };
        }
        #endregion
    }

}






using Microsoft.AspNetCore.Mvc;
using reposicion_pin.DTOs;
using reposicion_pin.Service;

// For more information on enabling Web API for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860

namespace reposicion_pin.Controllers
{
    [Route("api/[controller]")]
    [ApiController]
    public class ReposicionPinController : ControllerBase
    {
        private readonly ReposicionPinService _service;

        public ReposicionPinController(ReposicionPinService service)
        {
            _service = service;
        }

        [HttpPost]
        [Route("validar-tarjeta")]
        public async Task<ActionResult<ReposicionPinResponseDto>> ValidarTarjeta([FromBody] ReposicionPinRequestDto request)
        {
            var result = await _service.ValidarTarjetaAsync(request);
            return Ok(result);
        }

        /// <summary>
        /// Fase 2: Consumir AS400 para generar PIN
        /// </summary>
        [HttpPost]
        [Route("generar-pin")]
        public async Task<ActionResult<ReposicionPinResponseDto>> GenerarPin([FromBody] ReposicionPinRequestDto request)
        {
            // 1️⃣ Validar la tarjeta (fase 1)
            var fase1 = await _service.ValidarTarjetaAsync(request);
            if (fase1.CodigoInt != 0)
                return Ok(fase1);

            // 2️⃣ Obtener tarjeta de BD usando el método público del servicio
            var tarjeta = await _service.ObtenerTarjetaAsync(request.CIF, request.UltimosDigitosTC);
            if (tarjeta == null)
                return Ok(await _service.ObtenerRespuestaDinamicaAsync(5, "Tarjeta", "No se encontró tarjeta"));

            // 3️⃣ Consumir AS400
            var fase2 = await _service.Fase2_ConsumirAs400Async(tarjeta);

            return Ok(fase2);
        }
    }
}   
