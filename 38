Y si intentamos hacerlo como este ejemplo:





using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Data.OleDb;
using System.Data;
using System.Configuration;

namespace SistemaCobranzasBP.Clases
{
    public class ClassAS400
    {
        private string _ConnectionString;
        private string _Query;
        private string _Mensaje;
        private bool _Success;
        private int _CommandTimeout;
        private List<OleDbParameter> _Parametros = new List<OleDbParameter>();
        private DataTable _dtLibrerias = new DataTable();
        private string _Comando;
       // private List<> _Librerias = new List<OleDbParameter>();

        //Contructores de la clase
        #region Constructores
        public ClassAS400(string conexion,string query)
        {
            this._ConnectionString = conexion;
            this._Query = query;
            this._Mensaje = string.Empty;
            this._Success = true;
            this._CommandTimeout = 300;
            this._dtLibrerias = null;
            this._Comando = string.Empty;
        }


        public ClassAS400(string conexion, string query, DataTable librerias)
        {
            this._ConnectionString = conexion;
            this._Query = query;
            this._Mensaje = string.Empty;
            this._Success = true;
            this._CommandTimeout = 300;
            this._dtLibrerias = librerias;
            this.LimpiarParametros = true;
        } 
        #endregion

        //Propiendas de los campos
        #region Propiedades
        public string ConnectionString
        {
            set { this._ConnectionString = value; }
            get { return this._ConnectionString; }
        }

        public string Query
        {
            set { this._Query = value; }
            get { return this._Query; }
        }

        public string Mensaje
        {
            get { return this._Mensaje; }
        }

        public bool LimpiarParametros { get; set; }

        public List<OleDbParameter> Parametros
        {
            get { return this._Parametros; }
        }

        public bool Success
        {
            get { return this._Success; }
        }

        public int CommandTimeout
        {
            set { this._CommandTimeout = value; }
            get { return this._CommandTimeout; }
        }

        public string Comando
        {
            get { return this._Comando; }
        }
        public DataTable dtLibrerias
        {
            get { return this._dtLibrerias; }
        }
        #endregion

        //Ejecuta los Calls tipo Procedure con sus parametros correspondientes y regresa DataTable
        public DataTable dtProcedureCALL()
        {
            this._Mensaje = string.Empty;
            this._Success = true;
            DataTable dt = new DataTable();
            
            try
            {
                using (OleDbConnection Conn = new OleDbConnection(this._ConnectionString))                
                {
                    //Abre las conexiones si estan cerradas
                    if (Conn.State == ConnectionState.Closed)                    
                        Conn.Open();

                    OleDbCommand com = new OleDbCommand();
                    com.Connection = Conn;
                    com.CommandText = this._Query;
                    com.CommandType = CommandType.StoredProcedure;
                    com.CommandTimeout = this._CommandTimeout;


                    //Recorre los parametros para enviarlos a el Call
                    if (this._Parametros.Count > 0)
                    {
                        foreach (OleDbParameter param in this._Parametros)
                        {                           
                           
                            com.Parameters.Add(param);
                            //logParametros += " Parámetro " + param.ParameterName + " : " + param.Value + ", ";
                        }


                        using (OleDbDataReader reader = com.ExecuteReader())
                        {
                            dt.Load(reader);

                            if (!reader.IsClosed)
                                reader.Close();
                        }

                    }

                    

                    //Cierras las conexiones si estan abiertas
                    if (Conn.State == ConnectionState.Open)
                    {
                        Conn.Close();
                        Conn.Dispose();
                    }

                }

                            }
            catch (Exception ex)
            {
                //log.Error(ex.ToString() + logParametros);
                this._Mensaje = ex.Message.ToString();
                this._Success = false;
            }

            this._Parametros.Clear();
            return dt;
            
        }

        //Ejecuta los Calls con sus parametros correspondientes
        public void exeParamPRGCALL()
        {
            this._Mensaje = string.Empty;
            this._Success = true;
           // DataTable dt = new DataTable();

            try
            {
                using (OleDbConnection Conn = new OleDbConnection(this._ConnectionString))
                {
                    //Abre las conexiones si estan cerradas
                    if (Conn.State == ConnectionState.Closed)
                        Conn.Open();

                    //Creea el comando para ejecutar el programa
                    OleDbCommand com = new OleDbCommand(this._Query, Conn);
                    com.CommandType = CommandType.Text;   

                    //Recorre los parametros para enviarlos a el Call
                    if (this._Parametros.Count > 0)
                    {
                        foreach (OleDbParameter param in this._Parametros)
                        {

                            com.Parameters.Add(param);
                        }

                        //agrega las librerias para la ejecución del programa
                        if (this._dtLibrerias.Rows.Count > 0)
                        {
                            OleDbCommand comLib = new OleDbCommand();
                            comLib.CommandType = CommandType.Text;
                            comLib.Connection = Conn;

                            //Limpia la librerias ya cargadas anteriormente
                            comLib.CommandText = "{{CALL PGM(QSYS/QCMDEXC) PARM('CHGLIBL LIBL(*NONE)' 30)}}";
                            comLib.ExecuteNonQuery();

                            //Agrega las librerias parametrizadas en la tabla de la BD
                            foreach (DataRow row in _dtLibrerias.Rows) 
                            {                                
                                comLib.CommandText = "{{CALL PGM(QSYS/QCMDEXC) PARM('ADDLIBLE LIB("+row[0].ToString()+")' 30)}}";
                                comLib.ExecuteNonQuery();
                            }
                    
                        }

                        //Ejecuta el programa
                        com.ExecuteNonQuery();

                    }

                    //Cierras las conexiones si estan abiertas
                    if (Conn.State == ConnectionState.Open)
                    {
                        Conn.Close();
                        Conn.Dispose();
                    }

                }
            }
            catch (Exception ex)
            {
                //log.Error(ex.ToString() + logParametros);
                this._Mensaje = ex.Message.ToString();
                this._Success = false;
            }

            if (this.LimpiarParametros)
            {
                this._Parametros.Clear();
            }
            //return dt;

        }

        //Ejecuta los Calls con sus parametros correspondientes y devuelve DataTable
        public DataTable dtParamPRGCALL()
        {
            this._Mensaje = string.Empty;
            this._Success = true;
            DataTable dt = new DataTable();

            try
            {
                using (OleDbConnection Conn = new OleDbConnection(this._ConnectionString))
                {
                    //Abre las conexiones si estan cerradas
                    if (Conn.State == ConnectionState.Closed)
                        Conn.Open();

                    //Creea el comando para ejecutar el programa
                    OleDbCommand com = new OleDbCommand(this._Query, Conn);
                    com.CommandType = CommandType.Text;

                    //Recorre los parametros para enviarlos a el Call
                    if (this._Parametros.Count > 0)
                    {
                        foreach (OleDbParameter param in this._Parametros)
                        {

                            com.Parameters.Add(param);
                        }

                        //agrega las librerias para la ejecución del programa
                        if (this._dtLibrerias.Rows.Count > 0)
                        {
                            OleDbCommand comLib = new OleDbCommand();
                            comLib.CommandType = CommandType.Text;
                            comLib.Connection = Conn;

                            //Limpia la librerias ya cargadas anteriormente
                            comLib.CommandText = "{{CALL PGM(QSYS/QCMDEXC) PARM('CHGLIBL LIBL(*NONE)' 30)}}";
                            comLib.ExecuteNonQuery();

                            //Agrega las librerias parametrizadas en la tabla de la BD
                            foreach (DataRow row in _dtLibrerias.Rows)
                            {
                                comLib.CommandText = "{{CALL PGM(QSYS/QCMDEXC) PARM('ADDLIBLE LIB(" + row[0].ToString() + ")' 30)}}";
                                comLib.ExecuteNonQuery();
                            }

                        }

                        this._Comando = com.CommandText;
                        //Ejecuta el programa
                        com.ExecuteNonQuery();


                        //Crea el dt de respuesta
                        foreach (OleDbParameter param in this._Parametros)
                        {
                            dt.Columns.Add(param.ToString(), typeof(string));
                        }

                        //Llena dt de Respuesta
                        DataRow newRow = dt.NewRow();
                        foreach (OleDbParameter param in this._Parametros)
                        {
                            newRow[param.ToString()] = com.Parameters[param.ToString()].Value;

                        }

                        dt.Rows.Add(newRow);

                    }

                    //Cierras las conexiones si estan abiertas
                    if (Conn.State == ConnectionState.Open)
                    {
                        Conn.Close();
                        Conn.Dispose();
                    }

                }

            }
            catch (Exception ex)
            {
                //log.Error(ex.ToString() + logParametros);
                this._Mensaje = ex.Message.ToString();
                this._Success = false;
            }

            this._Parametros.Clear();
            return dt;

        }

    }
}





 private DataSet reponerPINAS400(string CIF, string Cuenta, string UltimosDigitosTD)
 {
     //Variables
     string tramaArmada = string.Empty;
     Trama trama = new Trama();
     //Crea la trama que se enviara al as400
     tramaArmada = trama.ArmarTrama(CIF, Cuenta, UltimosDigitosTD);
     log.Debug("Trama que será enviada: " + tramaArmada);
     DataSet dtCallConfig = new DataSet();
     DataSet dsResult = new DataSet();


     //Trae la configuración del SQL del programa que se ejecutara 
     SQLSrv sql = new SQLSrv(SqlConnectionString, "usp_configCallAs400");
     sql.Parametros.Add(new SqlParameter("@idCallAS400", 1));
     dtCallConfig = sql.getDataSetWithParameters();

     //Inicializa la clase de as400 para ejecución de CALL
     DataTable dtRepsuestaAS = new DataTable();
     ClassAS400 asCall = new ClassAS400(AsConnectionString, dtCallConfig.Tables[0].Rows[0]["CallAs400"].ToString(), dtCallConfig.Tables[1]);


     //Se agregan los parametros para realizar el CALL al AS400
     OleDbParameter par1 = new OleDbParameter("$peTramaMQRcv", OleDbType.Char, 100);
     par1.Value = tramaArmada;
     par1.Direction = ParameterDirection.InputOutput;

     asCall.Parametros.Add(par1);

     //Se ejecuta el CALL 
     log.Debug("Ejecutando programa: " + dtCallConfig.Tables[0].Rows[0]["CallAs400"].ToString());
     log.Debug("Parametros:");
     foreach (OleDbParameter item in asCall.Parametros)
     {
         log.Debug(item.ParameterName + " => " + item.Value);
     }

     dtRepsuestaAS = asCall.dtParamPRGCALL();

     //Evalua la respuesta del CALL si no genero ningun error al llamado
     if (asCall.Success != true)
     {
         log.Error("Error al ejecutar programa:" + asCall.Mensaje);
         dsResult = MensajeRespuesta("P99", asCall.Mensaje);
         return dsResult;
     }

     //Valida si contiene información el dtRespuestaAS
     if (dtRepsuestaAS.Rows.Count > 0)
     {
         string tramaRespuesta = dtRepsuestaAS.Rows[0][0].ToString();                
         

         try
         {
             //Variables que se utilizaran
             string codigoRespuesta, decripcionRespuesta, pinReinicio;
             int logitudTrama = tramaRespuesta.Length;

             //Parasea la trama de repuesta y asigna los campos
             pinReinicio = tramaRespuesta.Substring(34, 4).Trim();
             codigoRespuesta = tramaRespuesta.Substring(38, 3).Trim();
             decripcionRespuesta = tramaRespuesta.Substring(41, (logitudTrama - 41)).Trim();
             

             //Evalua si se genero pin para poder enmascarar el pin en la trama antes de guardarla en el log
             if(pinReinicio!=string.Empty)
                 log.Debug("Trama de respuesta de as400: " + tramaRespuesta.Replace(pinReinicio,"****"));
             else
                 log.Debug("Trama de respuesta de as400: " + tramaRespuesta);

             //Evalua el código de repsuesta del as400 
             if (codigoRespuesta != "200")
             {
                 log.Error("Descripción de error devuelto del as400:" + codigoRespuesta + "-" + decripcionRespuesta);
                 dsResult = MensajeRespuesta(codigoRespuesta, decripcionRespuesta);
                 return dsResult;
             }
             else
             {
                 pin = pinReinicio;
                 dsResult = MensajeRespuesta(codigoRespuesta, decripcionRespuesta);
             }
         }
         catch (Exception ex)
         {
             log.Error("Error parseando la trama:" + ex.Message);
             dsResult = MensajeRespuesta("P99", ex.Message);
             return dsResult;
         }

     }
     else
     {
         log.Error("Error al ejecutar programa: Trama respuesta vacía");
         dsResult = MensajeRespuesta("P99", "Trama respuesta vacÍa");
         return dsResult;
     }

     return dsResult;

 }



En SQL esta asi:

SELECT TOP (1000) [idCallAS400]
      ,[CallAs400]
      ,[tipoCall]
      ,[Activo]
  FROM [wsReposicionPIN].[dbo].[CallsAS400]


idCallAS400	CallAs400	tipoCall	Activo
1	{{CALL BPPGM/REIMQ01R(?)}}	C	1



------


SELECT TOP (1000) [idCallCamposAS400]
      ,[idCallAS400]
      ,[Campo]
      ,[TipoDato]
      ,[Longitud]
      ,[Direccion]
  FROM [wsReposicionPIN].[dbo].[CallsCamposAS400]

idCallCamposAS400	idCallAS400	Campo	TipoDato	Longitud	Direccion
1	1	peTramaMQRcv	Char	91	IO


----------------------

SELECT TOP (1000) [idLibreriasAS400]
      ,[idCallAS400]
      ,[Libreria]
  FROM [wsReposicionPIN].[dbo].[CallsLibreriasAS400]

idLibreriasAS400	idCallAS400	Libreria
1	1	DP053DAT
2	1	CLIDAT
3	1	BPDAT
4	1	BPPGM
5	1	TDBI20DAT
