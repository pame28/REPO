using reposicion_pin.Infrastructure.Data;
using reposicion_pin.Models;
using reposicion_pin.Repository.Interface;
using System.Net.Mail;

namespace reposicion_pin.Repository
{
    public class EnvioEmailRepository : IEnvioEmailRepository
    {
        private readonly AppDbContext _dbContext;
        private readonly ILogger<EnvioEmailRepository> _logger;
        private readonly ParamAmbienteModel _paramAmbiente;

        private readonly string _serverEmail;
        private readonly string _mailFrom;
        private readonly string _mailSubject;

        public EnvioEmailRepository(
            AppDbContext dbContext,
            ILogger<EnvioEmailRepository> logger)
        {
            _dbContext = dbContext;
            _logger = logger;

            var configEmail = _dbContext
                .usp_ObtenerConfigEmail
                .AsEnumerable()
                .FirstOrDefault();

            if (configEmail == null)
                throw new Exception("No se encontró configuración de ConfigEmail.");

            _serverEmail = configEmail.ServerEmail;
            _mailFrom = configEmail.MailFrom;
            _mailSubject = configEmail.MailSubject;

            _paramAmbiente = _dbContext.ParamAmbiente
                .Where(p => p.Estado == 1)
                .OrderBy(p => p.IdRow)
                .FirstOrDefault();
        }

        public async Task<(int Codigo, string Mensaje)> EnviarCorreoAsync(
            string correoDestino,
            string cuerpoBase,
            string pin,
            string referencia,
            CancellationToken cancellationToken)
        {
            try
            {
                string correoFinal = _paramAmbiente?.Correo ?? correoDestino;
             //   string cuerpoFinal = cuerpoBase.Replace("{PIN}", pin);

                var ruta = Path.Combine(Directory.GetCurrentDirectory(), "Templates", "PinCorreo.html");
                var html = await File.ReadAllTextAsync(ruta);
               var cuerpoFinal = plantillaHtml.Replace("{PIN}", pin);


                using var smtp = new SmtpClient(_serverEmail)
                {
                    DeliveryMethod = SmtpDeliveryMethod.Network,
                    UseDefaultCredentials = true
                };

                using var mail = new MailMessage
                {
                    From = new MailAddress(_mailFrom),
                    Subject = _mailSubject,
                    Body = cuerpoFinal,
                    IsBodyHtml = true
                };

                mail.To.Add(correoFinal);

                await smtp.SendMailAsync(mail, cancellationToken);

                _logger.LogInformation(
                    "Correo enviado Ref:{Referencia} Destino:{Destino}",
                    referencia, correoFinal);

                return (0, "Correo enviado correctamente.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex,
                    "Error enviando correo Ref:{Referencia} Destino:{Destino}",
                    referencia, correoDestino);

                return (8, ex.Message);
            }
        }
    }
}




Ayudame a corregir el codigo completo, veo que tambien hay que modificar la interface. Por cierto mi plantilla está en una carpeta dentro del proyecto general llamada Templates y el archivo se llama Correo.html
