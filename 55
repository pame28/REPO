using System.Threading;
using System.Threading.Tasks;

namespace reposicion_pin.Repository.Interface
{
    public interface IEnvioEmailRepository
    {
        Task<(int Codigo, string Mensaje)> EnviarCorreoAsync(
            string correoDestino,
            string cuerpoBase,
            string pin,
            string referencia,
            CancellationToken cancellationToken);
    }
}










using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using reposicion_pin.Infrastructure.Data;
using reposicion_pin.Repository.Interface;
using System;
using System.Linq;
using System.Net;
using System.Net.Mail;
using System.Threading;
using System.Threading.Tasks;

namespace reposicion_pin.Repository
{
    public class EnvioEmailRepository : IEnvioEmailRepository
    {
        private readonly AppDbContext _dbContext;
        private readonly ILogger<EnvioEmailRepository> _logger;

        public EnvioEmailRepository(
            AppDbContext dbContext,
            ILogger<EnvioEmailRepository> logger)
        {
            _dbContext = dbContext;
            _logger = logger;
        }

        public async Task<(int Codigo, string Mensaje)> EnviarCorreoAsync(
            string correoDestino,
            string cuerpoBase,
            string pin,
            string referencia,
            CancellationToken cancellationToken)
        {
            try
            {
                var config = await _dbContext.ConfigEmail
                    .Where(x => x.Estado == 1)
                    .OrderBy(x => x.IdRows)
                    .FirstOrDefaultAsync(cancellationToken);

                if (config == null)
                {
                    _logger.LogError("No existe configuración activa en ConfigEmail");
                    return (8, "No existe configuración activa de correo.");
                }

                string cuerpoFinal = cuerpoBase.Replace("{PIN}", pin);

                using var smtp = new SmtpClient(config.ServerEmail)
                {
                    DeliveryMethod = SmtpDeliveryMethod.Network,
                    UseDefaultCredentials = true
                };

                using var mail = new MailMessage
                {
                    From = new MailAddress(config.MailFrom),
                    Subject = config.MailSubject,
                    Body = cuerpoFinal,
                    IsBodyHtml = true
                };

                mail.To.Add(correoDestino);

                await smtp.SendMailAsync(mail, cancellationToken);

                _logger.LogInformation(
                    "Correo enviado Ref:{Referencia} Destino:{Destino}",
                    referencia, correoDestino);

                return (0, "Correo enviado correctamente.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex,
                    "Error enviando correo Ref:{Referencia} Destino:{Destino}",
                    referencia, correoDestino);

                return (8, ex.Message);
            }
        }
    }
}














private async Task InsertarRegistroEnvioEmailAsync(
    TarjetaModel tarjeta,
    ReposicionPinRequestDto request,
    string referencia,
    int codigo,
    string mensaje)
{
    try
    {
        string tipoTarjeta = _configuration["ParametrosSMS:TipoTarjeta"] ?? "TDC";

        var entidad = new BandejaEnvioEmailModel
        {
            NumeroTarjeta = tarjeta.NumeroTarjeta,
            CuerpoCorreo = request.ContenidoCorreo,
            MailFrom = null, // puedes traerlo si deseas
            MailSubject = null,
            Correo = request.Correo,
            Referencia = referencia,
            FechaInicio = DateTime.Now,
            FechaFinal = DateTime.Now,
            TipoTarjeta = tipoTarjeta,
            Estado = codigo,
            DescripcionEstado = mensaje
        };

        _dbContext.BandejaEnvioEmail.Add(entidad);
        await _dbContext.SaveChangesAsync();
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error registrando resultado Email");
    }
}





if (request.MetodoEnvio == 2)
{
    long numeroTransaccion = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();
    string referencia = numeroTransaccion.ToString();

    var resultado = await _envioEmailRepository.EnviarCorreoAsync(
        request.Correo,
        request.ContenidoCorreo,
        pin,
        referencia,
        CancellationToken.None
    );

    await InsertarRegistroEnvioEmailAsync(
        tarjeta,
        request,
        referencia,
        resultado.Codigo,
        resultado.Mensaje
    );

    if (resultado.Codigo != 0)
    {
        return await ObtenerRespuestaDinamicaAsync(
            8,
            "Codigo de Respuesta:",
            $"{resultado.Codigo} - {resultado.Mensaje}"
        );
    }
}


