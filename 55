public async Task<(int Codigo, string Mensaje)> 
    EnviarSmsDirectoAsync(
        string telefono,
        string operador,
        string mensaje,
        string referencia,
        CancellationToken cancellationToken)
{
    try
    {
        string telefonoFinal = _paramAmbiente?.Telefono ?? telefono;
        string operadorFinal = _paramAmbiente?.IdOperador ?? operador;

        var response = await _mensajesSoapClient.Envia_MensajeAsync(
            _UsrBiMovil,
            _PassBiMovil,
            telefonoFinal,
            operadorFinal,
            mensaje,
            referencia,
            string.Empty,
            string.Empty
        );

        XmlDocument xmlDoc = new XmlDocument();
        xmlDoc.LoadXml(response.Envia_MensajeResult.Any1.InnerXml);

        XmlNode nodoCod = xmlDoc.GetElementsByTagName("cod_ret")[0];
        XmlNode nodoMensaje = xmlDoc.GetElementsByTagName("mensaje")[0];

        int codigo = nodoCod != null ? int.Parse(nodoCod.InnerText) : 99;
        string mensajeRespuesta = nodoMensaje?.InnerText ?? "Respuesta inv√°lida";

        _logger.LogInformation(
            "BiMovil Ref:{Referencia} Codigo:{Codigo} Mensaje:{Mensaje}",
            referencia, codigo, mensajeRespuesta);

        return (codigo, mensajeRespuesta);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error enviando SMS Ref:{Referencia}", referencia);
        return (99, ex.Message);
    }
}






var pin = as400Response.Pin;

if (request.MetodoEnvio == 1)
{
    var mensajeFinal = request.ContenidoSMS.Replace("{PIN}", pin);
    var referencia = DateTime.Now.ToString("yyMMddHHmmss");

    var resultado = await _envioSmsRepository.EnviarSmsDirectoAsync(
        request.Telefono,
        request.OperadorTelefono,
        mensajeFinal,
        referencia,
        CancellationToken.None
    );

    // Guardar lo que responde BiMovil
    await InsertarRegistroEnvioAsync(
        tarjeta,
        request,
        referencia,
        resultado.Codigo,
        resultado.Mensaje
    );

    // Si no es exitoso, usar tu cat√°logo
    if (resultado.Codigo != 0)
    {
        return await ObtenerRespuestaDinamicaAsync(
            7,
            "BiMovil",
            $"{resultado.Codigo} - {resultado.Mensaje}"
        );
    }
}








private async Task InsertarRegistroEnvioAsync(
    TarjetaModel tarjeta,
    ReposicionPinRequestDto request,
    string referencia,
    int codigoBiMovil,
    string mensajeBiMovil)
{
    try
    {
        string tipoTarjeta = _configuration["ParametrosSMS:TipoTarjeta"] ?? "TDC";

        var entidad = new BandejaEnvioSmsModel
        {
            NumeroTarjeta = tarjeta.NumeroTarjeta,
            Celular = request.Telefono,
            Telco = request.OperadorTelefono,
            Referencia = referencia,
            FechaInicio = DateTime.Now,
            FechaFinal = DateTime.Now,
            TipoTarjeta = tipoTarjeta,
            Estado = codigoBiMovil, // üî• aqu√≠ guardas cod_ret
            DescripcionEstado = mensajeBiMovil
        };

        await _bandejaSmsRepository.AddAsync(entidad);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error registrando resultado SMS");
    }
}

