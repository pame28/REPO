Task<(bool Exitoso, string Codigo, string Mensaje)> 
    EnviarSmsDirectoAsync(
        string telefono,
        string operador,
        string mensaje,
        string referencia,
        CancellationToken cancellationToken);








public async Task<(bool Exitoso, string Codigo, string Mensaje)> 
    EnviarSmsDirectoAsync(
        string telefono,
        string operador,
        string mensaje,
        string referencia,
        CancellationToken cancellationToken)
{
    try
    {
        // Aplicar override de ambiente si existe
        string telefonoFinal = _paramAmbiente?.Telefono ?? telefono;
        string operadorFinal = _paramAmbiente?.IdOperador ?? operador;

        _logger.LogInformation("Enviando SMS directo Ref:{Referencia} a {Telefono}", 
            referencia, telefonoFinal);

        var response = await _mensajesSoapClient.Envia_MensajeAsync(
            _UsrBiMovil,
            _PassBiMovil,
            telefonoFinal,
            operadorFinal,
            mensaje,
            referencia,
            string.Empty,
            string.Empty
        );

        // Parsear XML de respuesta
        XmlDocument xmlDoc = new XmlDocument();
        xmlDoc.LoadXml(response.Envia_MensajeResult.Any1.InnerXml);

        XmlNode nodo = xmlDoc.GetElementsByTagName("respuesta")[0];
        string cadena = nodo.InnerText;

        string codigo = cadena.Substring(0, 1);
        string mensajeRespuesta = cadena.Length > 1 ? cadena.Substring(1) : "";

        bool exitoso = codigo == "0";

        _logger.LogInformation(
            "Resultado SMS Ref:{Referencia} CÃ³digo:{Codigo} Mensaje:{Mensaje}",
            referencia, codigo, mensajeRespuesta);

        return (exitoso, codigo, mensajeRespuesta);
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Error enviando SMS directo Ref:{Referencia}", referencia);
        return (false, "9", ex.Message);
    }
}











var pin = as400Response.Pin;

if (request.MetodoEnvio == 1)
{
    var mensajeFinal = request.ContenidoSMS.Replace("{PIN}", pin);

    var referencia = DateTime.Now.ToString("yyMMddHHmmss");

    var resultado = await _envioSmsRepository.EnviarSmsDirectoAsync(
        request.Telefono,
        request.OperadorTelefono,
        mensajeFinal,
        referencia,
        CancellationToken.None
    );

    await InsertarRegistroEnvioAsync(
        tarjeta,
        request,
        referencia,
        resultado.Exitoso,
        resultado.Mensaje
    );
}




