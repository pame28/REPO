using reposicion_pin.Infrastructure.Data;
using reposicion_pin.Models;
using reposicion_pin.Repository.Interface;
using System.Net.Mail;

namespace reposicion_pin.Repository
{
    public class EnvioEmailRepository : IEnvioEmailRepository
    {
        private readonly AppDbContext _dbContext;
        private readonly ILogger<EnvioEmailRepository> _logger;
        private readonly ParamAmbienteModel _paramAmbiente;

        public EnvioEmailRepository(
            AppDbContext dbContext,
            ILogger<EnvioEmailRepository> logger)
        {
            _dbContext = dbContext;
            _logger = logger;


            // Obtener configuraci贸n de Email desde SP
            var configEmail = _dbContext
                .usp_ObtenerConfigEmail
                .AsEnumerable()
                .FirstOrDefault();


            if (configEmail == null)
            {
                _logger.LogError("No existe configuraci贸n activa en ConfigEmail");
                throw new Exception("No se encontr贸 configuraci贸n de ConfigEmail.");
            }


            _paramAmbiente = _dbContext.ParamAmbiente
               .Where(p => p.Estado == 1)
               .OrderBy(p => p.IdRow)
               .FirstOrDefault();
        }




        public async Task<(int Codigo, string Mensaje)> EnviarCorreoAsync(
            string correoDestino,
            string cuerpoBase,
            string pin,
            string referencia,
            CancellationToken cancellationToken)
        {
            try
            {

                string correo = _paramAmbiente?.Correo ?? correoDestino;

                string cuerpoFinal = cuerpoBase.Replace("{PIN}", pin);

                using var smtp = new SmtpClient(configEmail.ServerEmail)
                {
                    DeliveryMethod = SmtpDeliveryMethod.Network,
                    UseDefaultCredentials = true
                };

                using var mail = new MailMessage
                {
                    From = new MailAddress(configEmail.MailFrom),
                    Subject = configEmail.MailSubject,
                    Body = cuerpoFinal,
                    IsBodyHtml = true
                };

                mail.To.Add(correoDestino);

                await smtp.SendMailAsync(mail, cancellationToken);

                _logger.LogInformation(
                    "Correo enviado Ref:{Referencia} Destino:{Destino}",
                    referencia, correoDestino);

                return (0, "Correo enviado correctamente.");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex,
                    "Error enviando correo Ref:{Referencia} Destino:{Destino}",
                    referencia, correoDestino);

                return (8, ex.Message);
            }
        }
    }
}










El nombre 'configEmail' no existe en el contexto actual
El nombre 'configEmail' no existe en el contexto actual
El nombre 'configEmail' no existe en el contexto actual
