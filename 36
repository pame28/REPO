using reposicion_pin.DTOs;
using reposicion_pin.Repository.Interface;
using System.Configuration;
using System.Data;
using System.Data.OleDb;
using static Microsoft.EntityFrameworkCore.DbLoggerCategory;

namespace reposicion_pin.Repository
{
    public class AS400Repository : IAS400Repository
    {
        private readonly string _connectionString;
        private readonly ILogger<AS400Repository> _logger;

        public AS400Repository(
            IConfiguration configuration,
            ILogger<AS400Repository> logger)
        {
            _connectionString = configuration.GetConnectionString("AS400Connection")!;
            _logger = logger;
        }

        public async Task<AS400ResponseDto> EjecutarProgramaAsync(AS400RequestDto request)
        {
            try
            {
                using var conn = new OleDbConnection(_connectionString);
                await conn.OpenAsync();

                // 1️⃣ Armar la trama (81)
                string trama =
                    request.EquivalenteTC.PadRight(16) +
                    request.FechaVencimiento.PadRight(8) +
                    new string(' ', 57);

                // 2️⃣ CALL directo al programa (SIN CHGLIBL)
                string sql = "CALL BPPGM/REIMQ07RC (?)";

                using var cmd = new OleDbCommand(sql, conn);
                cmd.CommandType = CommandType.Text;
                cmd.CommandTimeout = 300;

                var paramTrama = new OleDbParameter
                {
                    OleDbType = OleDbType.Char,
                    Size = 81,
                    Direction = ParameterDirection.InputOutput,
                    Value = trama
                };

                cmd.Parameters.Add(paramTrama);

                _logger.LogInformation("Ejecutando REIMQ07RC en AS400");
                _logger.LogDebug("Trama enviada: {Trama}", trama);

                await cmd.ExecuteNonQueryAsync();

                string tramaRespuesta = paramTrama.Value?.ToString() ?? string.Empty;

                return ParsearRespuesta(tramaRespuesta);
            }
            catch (OleDbException ex)
            {
                _logger.LogError(ex, "Error OleDb AS400");

                return new AS400ResponseDto
                {
                    CodigoError = "P98",
                    DescripcionError = "ERROR AL LLAMAR A MQ"
                };
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error inesperado AS400");

                return new AS400ResponseDto
                {
                    CodigoError = "P99",
                    DescripcionError = "TRAMA NO ENCONTRADA"
                };
            }
        }

        private static AS400ResponseDto ParsearRespuesta(string trama)
        {
            if (trama.Length < 81)
            {
                return new AS400ResponseDto
                {
                    CodigoError = "P99",
                    DescripcionError = "TRAMA RESPUESTA INVÁLIDA"
                };
            }

            return new AS400ResponseDto
            {
                Pin = trama.Substring(24, 4).Trim(),
                CodigoError = trama.Substring(28, 3).Trim(),
                DescripcionError = trama.Substring(31, 50).Trim()
            };
        }
    }
}



Esta es la cadena de conexion: 

 "AS400Connection": "Provider=IBMDA400.DataSource.1;Data Source=****;Persist Security Info=True;Password=***;User ID=*****;"





Esto es lo unco que puedo ver en DBvISUALIZER:
PROCEDURE_CAT	PROCEDURE_SCHEM	PROCEDURE_NAME	COLUMN_NAME	COLUMN_TYPE	DATA_TYPE	TYPE_NAME	PRECISION	LENGTH	SCALE	RADIX	NULLABLE	REMARKS	SQL_DATA_TYPE	SQL_DATETIME_SUB	CHAR_OCTET_LENGTH	ORDINAL_POSITION	IS_NULLABLE	SPECIFIC_NAME
"SBP720P"	"BPPGM"	"SP_REIMQ07RC"	"V_INFO"	1	1	"CHAR"	81	81	(null)	(null)	1	(null)	1	(null)	81	1	"YES"	"SP_RPESINCONS"


Esta es una firma que me enviaron de como loe ejecutan;

CALL PGM(REIMQ07RC) PARM(('100000000170384120191130'))


eSTAS SON LAS LIBRERIAS QUE NECESITA:

DP053DAT, CLIDAT, BPDAT, BPPGM, TDBI20DAT, TARJETA



Esto es lo que me pasaron por correo:

El programa es el REIMQ07RC(Este no es el programa final) está en la librería BPPGM, este recibe una trama de longitud 81 tipo char de la cual te detallo las posiciones:
Campo	Posición Inicial	Posición Final	Tamaño
Equivalente TC	1	16	16
Fecha Vencimiento TC	17	24	8
PIN TC	25	28	4
Código Error	29	31	3
Descripción Error	32	81	50

Y esto son algunos de los errores con los que puede responder:

A continuación, te detallo los errores:
Cod Error	Descripción
P01	EQUIVALENTE TARJETA EN BLANCO
P02	FECHA VENCIMIENTO TARJETA EN BLANCO
P03	TARJETA NO EXISTE
P98	ERROR AL LLAMAR A MQ
P99	TRAMA NO ENCONTRADA


 Mira, no se cual puede ser mi error :( Ayudame 
