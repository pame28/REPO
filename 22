public class AS400Repository : IAS400Repository
{
    private readonly string _connectionString;
    private readonly ILogger<AS400Repository> _logger;

    public AS400Repository(IConfiguration config, ILogger<AS400Repository> logger)
    {
        _connectionString = config.GetConnectionString("AS400");
        _logger = logger;
    }

    public async Task<AS400ResponseDto> EjecutarProgramaAsync(AS400RequestDto request)
    {
        try
        {
            using var conn = new OleDbConnection(_connectionString);
            await conn.OpenAsync();

            // 1️⃣ Limpiar LIBL
            await EjecutarComando(conn, "CHGLIBL LIBL(*NONE)");

            // 2️⃣ Agregar librerías (orden IMPORTA)
            string[] librerias =
            {
                "DP053DAT",
                "CLIDAT",
                "BPDAT",
                "BPPGM",
                "TDBI20DAT",
                "TARJETA"
            };

            foreach (var lib in librerias)
            {
                await EjecutarComando(conn, $"ADDLIBLE LIB({lib})");
            }

            // 3️⃣ Construir trama (81 chars)
            string trama =
                request.EquivalenteTC.PadRight(16) +
                request.FechaVencimiento.PadRight(8) +
                "".PadRight(4) +
                "".PadRight(3) +
                "".PadRight(50);

            // 4️⃣ Ejecutar programa
            using var cmd = new OleDbCommand(
                "CALL PGM(REIMQ07RC) PARM(?)", conn);

            var parm = new OleDbParameter
            {
                OleDbType = OleDbType.Char,
                Size = 81,
                Direction = ParameterDirection.InputOutput,
                Value = trama
            };

            cmd.Parameters.Add(parm);
            await cmd.ExecuteNonQueryAsync();

            return ParsearRespuesta(parm.Value.ToString());
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error consumiendo AS400");
            throw;
        }
    }

    private async Task EjecutarComando(OleDbConnection conn, string comando)
    {
        using var cmd = new OleDbCommand("CALL QSYS.QCMDEXC(?, ?)", conn);
        cmd.Parameters.Add(new OleDbParameter
        {
            OleDbType = OleDbType.Char,
            Value = comando
        });

        cmd.Parameters.Add(new OleDbParameter
        {
            OleDbType = OleDbType.Decimal,
            Value = comando.Length
        });

        await cmd.ExecuteNonQueryAsync();
    }
}
