using BPNotificaSMS.Models.BPNotifica;
using BPNotificaSMS.Repository;
using log4net;
using Microsoft.EntityFrameworkCore;
using System.Configuration;

namespace BPNotificaSMS
{
	public class Worker : BackgroundService
	{
		private readonly ILogger<Worker> _logger;
		private readonly ILog _log;
		private readonly IServiceProvider _serviceProvider;
        private readonly string _TipoTarjeta;
        public Worker(ILogger<Worker> logger, ILog log,IServiceProvider serviceProvider, IConfiguration configuration)
		{
			_logger = logger;
			_serviceProvider = serviceProvider;
			_log = LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);
            _TipoTarjeta = configuration.GetSection("TipoTarjeta").Value.Trim().ToUpper();
            _log.Info("Iniciando servicio");
		}

		protected override async Task ExecuteAsync(CancellationToken stoppingToken)
		{
			_log.Info($"Worker running");
            int intervalo = 200;

            while (!stoppingToken.IsCancellationRequested)
			{
				using (IServiceScope scope = _serviceProvider.CreateScope())
				{
                    BPNotificaContext dbContext = scope.ServiceProvider.GetRequiredService<BPNotificaContext>();

                    if (!await ValidarTablasAsync(dbContext, stoppingToken))
                    {
                        _log.Warn("Se omite el envío de SMS debido a que hay tablas vacías.");
                    }
                    else
                    {
                        EnviaMensajeRespository repository = scope.ServiceProvider.GetRequiredService<EnviaMensajeRespository>();
                        await EnviarSMS(repository, stoppingToken);
                    }
                }

				using (IServiceScope scope = _serviceProvider.CreateScope())
				{
					BPNotificaContext _dbContext=scope.ServiceProvider.GetRequiredService<BPNotificaContext>();
					intervalo = _dbContext.ParamIntervalosEjecucions.Where(s => s.TipoTarjeta == _TipoTarjeta).Select(s => s.Sms).First();
				}

				await Task.Delay(intervalo, stoppingToken);
			}
			_log.Info("Deteniendo servicio");
		}

		protected async Task EnviarSMS(EnviaMensajeRespository enviaMensajeRespository, CancellationToken cancellationToken)
		{
			try
			{
				await enviaMensajeRespository.EnviarSMSAsync(cancellationToken);
			}
			catch (Exception ex)
			{
				_log.Error("Error en async Task EnviarSMS: ", ex);
			}
		}
        private async Task<bool> ValidarTablasAsync(BPNotificaContext context, CancellationToken cancellationToken)
        {
            var tablasVacias = new List<string>();
            if (!await context.ResponseCodes.AnyAsync(cancellationToken)) tablasVacias.Add("ResponseCode");
            if (!await context.ProcessingCodes.AnyAsync(cancellationToken)) tablasVacias.Add("ProcessingCode");
            if (!await context.ExcepcionesClientes.AnyAsync(cancellationToken)) tablasVacias.Add("ExcepcionesClientes");
            if (!await context.Eusuarios.AnyAsync(cancellationToken)) tablasVacias.Add("EUsuarios");
            if (!await context.Etarjetas.AnyAsync(cancellationToken)) tablasVacias.Add("ETarjetas");
            if (!await context.DatosContactoClientes.AnyAsync(cancellationToken)) tablasVacias.Add("DatosContactoCliente");
            if (!await context.TelcoPredeterminada.AnyAsync(cancellationToken)) tablasVacias.Add("TelcoPredeterminada");
            if (tablasVacias.Any())
            {
                _log.Warn($"Las siguientes tablas están vacías: {string.Join(", ", tablasVacias)}");
                return false;
            }
            return true;
        }

    }
}


Mira lo encontré, como hago el mio?

