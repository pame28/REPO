Mira, me solicitaron que, para el envio de SMS me basara en este codigo: 

"Me gustaría que el tema de consumo al ws para envio de sms, manejo de usuario y contraseña sea como en este proyecto"



using BPNotificaSMS.Models.BPNotifica;
using log4net;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Internal;
using Microsoft.EntityFrameworkCore.Query.SqlExpressions;
using Microsoft.Extensions.Configuration;
using System;
using System.Collections.Generic;
using System.Data;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Xml;
using wsBiMovil;

namespace BPNotificaSMS.Repository
{
    public class EnviaMensajeRespository
    {
        private readonly ILog _log;
        private readonly ILogger<EnviaMensajeRespository> _logger;
        private readonly MensajesSoapClient _mensajesSoapClient;
        private readonly BPNotificaContext _dbContext;
        private static readonly SemaphoreSlim _semaphoreSlim = new SemaphoreSlim(1, 1);
        private readonly string _UsrBiMovil;
        private readonly string _PassBiMovil;
        private readonly ParamAmbiente _paramAmbiente;
        private readonly string _TipoTarjeta;

        public EnviaMensajeRespository(ILogger<EnviaMensajeRespository> logger, IConfiguration configuration, BPNotificaContext dbContext, ILog log)
        {
            _logger = logger;
            _log = log;
            _mensajesSoapClient = new MensajesSoapClient(MensajesSoapClient.EndpointConfiguration.MensajesSoap);
            _dbContext = dbContext;
            List<usp_ObtenerConfigBiMovil> configBiMovil = _dbContext.usp_ObtenerConfigBiMovil.ToList();
            this._UsrBiMovil = configBiMovil[0].UserBiMovil;
            this._PassBiMovil = configBiMovil[0].PassBiMovil;
            _paramAmbiente = _dbContext.ParamAmbientes.Where(s => s.Estado == 1).FirstOrDefault();
            _TipoTarjeta = configuration.GetSection("TipoTarjeta").Value.Trim().ToUpper();
        }

        public async Task EnviarSMSAsync(CancellationToken cancellationToken)
        {
            try
            {
                log4net.LogicalThreadContext.Properties["activityid"] = new ActivityIdHelper().ToString();

                if (!cancellationToken.IsCancellationRequested)
                {
                    List<BandejaEnvioSm> bandejaEnvioSms = _dbContext.BandejaEnvioSms.Where(s => s.Estado == 0 && s.TipoTarjeta == _TipoTarjeta).ToList();
                    Envia_MensajeResponseEnvia_MensajeResult envia_MensajeResponseEnvia_MensajeResult = new Envia_MensajeResponseEnvia_MensajeResult();
                    Envia_MensajeResponse response = new Envia_MensajeResponse(envia_MensajeResponseEnvia_MensajeResult);

                    string codigo = string.Empty;
                    string mensajeR = string.Empty;
                    int maxHilos = _dbContext.ParamHilos.Where(s => s.TipoTarjeta == _TipoTarjeta).Select(s => s.Sms).First();

                    _log.Info($"Procesando lote: {bandejaEnvioSms.Count} SMS - {_TipoTarjeta} pendientes.");
                    ParallelOptions options = new ParallelOptions
                    {
                        MaxDegreeOfParallelism = maxHilos
                    };
                    await Parallel.ForEachAsync(bandejaEnvioSms, options, async (item, _) =>
                    {

                        try
                        {
                            if (_paramAmbiente is null)
                            {
                                response = await _mensajesSoapClient.Envia_MensajeAsync(
                                    _UsrBiMovil, _PassBiMovil, item.Celular, item.Telco, item.Sms, item.Referencia, string.Empty, string.Empty
                                );
                            }
                            else
                            {
                                response = await _mensajesSoapClient.Envia_MensajeAsync(
                                    _UsrBiMovil, _PassBiMovil, _paramAmbiente.Telefono, _paramAmbiente.IdOperador, item.Sms, item.Referencia, string.Empty, string.Empty
                                );
                            }


                            XmlElement xmlElements = response.Envia_MensajeResult.Any1;

                            XmlDocument xmlDocument = new XmlDocument();
                            xmlDocument.LoadXml(xmlElements.InnerXml);
                            XmlNodeList nodo = xmlDocument.GetElementsByTagName("respuesta");
                            string cadena = nodo[0].InnerText;

                            codigo = cadena.Substring(0, 1);
                            mensajeR = cadena.Substring(1, cadena.Length - 1);


                            // Verificar respuesta y actualizar estado en la base de datos
                            if (codigo == "0")
                            {
                                _log.Info($"Notificación No. {item.Referencia} enviada correctamente. - {_TipoTarjeta}: {item.NumeroTarjeta}, Respuesta BiMovil: {mensajeR}");

                                await ActualizarEstadoEnviadoAsync(item.IdRow, 1, mensajeR, cancellationToken);

                            }
                            else
                            {
                                _log.Warn($"Notificación No. {item.Referencia} no enviada. - {_TipoTarjeta}: {item.NumeroTarjeta}, Respuesta BiMovil: {mensajeR}");
                                await ActualizarEstadoEnviadoAsync(item.IdRow, 2, mensajeR, cancellationToken);
                            }
                        }
                        catch (Exception ex)
                        {
                            _log.Error($"Error al enviar la notificación No. {item.Referencia}. - {_TipoTarjeta}: {item.NumeroTarjeta}, Respuesta BiMovil: {mensajeR}");
                            _log.Error(ex.Message);
                            await ActualizarEstadoEnviadoAsync(item.IdRow, 3, ex.Message, cancellationToken);
                        }

                    });
                }
                else
                {
                    _log.Info("Se ha detenido el servicio debito a solicitud de CancellationToken");
                }
            }
            catch (Exception ex)
            {
                _log.Error("Error en async Task<bool> EnviarSMSAsync", ex);
            }
        }

        private async Task ActualizarEstadoEnviadoAsync(int idRow, int estado, string descripcion, CancellationToken cancellationToken)
        {
            await _semaphoreSlim.WaitAsync(cancellationToken);
            try
            {
                BandejaEnvioSm registro = await _dbContext.BandejaEnvioSms.FindAsync(idRow);
                if (registro != null)
                {
                    registro.Estado = estado;
                    registro.FechaFinal = DateTime.Now;
                    registro.DescripcionEstado = descripcion;

                    await _dbContext.SaveChangesAsync(cancellationToken);
                }
            }
            catch (Exception ex)
            {
                _log.Error("Error en ActualizarEstadoEnviadoAsync", ex);
            }
            finally
            {
                _semaphoreSlim.Release();
            }


        }
    }
}
