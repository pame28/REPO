using reposicion_pin.DTOs;
using reposicion_pin.Service.Interface;

namespace reposicion_pin.Service
{
    public class ReposicionPinFlujoService
    {
        private readonly ITarjetaService _tarjetaService;
        private readonly IPinService _pinService;

        public ReposicionPinFlujoService(ITarjetaService tarjetaService, IPinService pinService)
        {
            _tarjetaService = tarjetaService;
            _pinService = pinService;
        }

        public async Task<ReposicionPinDto> EjecutarFlujoReposicionPinAsync(string equivalenteTC, string nuevoPin)
        {
            // 1️⃣ Validamos la tarjeta
            var validacion = await _tarjetaService.ValidarTarjetaAsync(equivalenteTC);
            if (!validacion.Existe)
            {
                return new ReposicionPinDto
                {
                    EquivalenteTC = equivalenteTC,
                    Exito = false,
                    CodigoError = validacion.CodigoError,
                    DescripcionError = validacion.MensajeError
                };
            }

            // 2️⃣ Reposicionamos el PIN
            var resultadoPin = await _pinService.ReposicionarPinAsync(equivalenteTC, nuevoPin);
            return resultadoPin;
        }
    }
}
